<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MouseGame: –≠–º—É–ª—è—Ç–æ—Ä, –†–µ–¥–∞–∫—Ç–æ—Ä –∏ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω–µ–π</title>
  
  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Montserrat Semi Bold (600) -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">

  <style>
    :root {
      --accent-color: #0f8;
      --accent-shadow: rgba(0, 255, 136, 0.3);
      --bg-color: #111;
      --section-bg: #1a1a1a;
      --text-color: #eee;
      --border-color: #333;
      --input-bg: #222;
    }

    .light-theme {
      --bg-color: #f0f0f0;
      --section-bg: #ffffff;
      --text-color: #111;
      --border-color: #ddd;
      --input-bg: #f5f5f5;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      background: var(--bg-color);
      color: var(--text-color);
      text-align: center;
      padding: 20px;
      margin: 0;
      line-height: 1.4;
      min-height: 100vh;
      position: relative;
      padding-bottom: 60px;
      transition: background-color 0.3s, color 0.3s;
    }
    
    h1 {
      color: var(--accent-color);
      margin-bottom: 10px;
      font-size: 28px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin: 20px 0;
      background: linear-gradient(135deg, var(--section-bg) 0%, color-mix(in srgb, var(--section-bg) 80%, #000) 100%);
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .tab-btn {
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      font-size: 14px;
      padding: 12px 24px;
      cursor: pointer;
      background: color-mix(in srgb, var(--section-bg) 60%, #000);
      color: var(--text-color);
      border: none;
      border-radius: 8px;
      transition: all 0.3s;
      flex: 1;
      max-width: 200px;
    }
    
    .tab-btn:hover {
      background: color-mix(in srgb, var(--section-bg) 40%, #000);
      transform: translateY(-2px);
    }
    
    .tab-btn.active {
      background: var(--accent-color);
      color: #111;
      box-shadow: 0 4px 12px var(--accent-shadow);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ */
    .section {
      background: var(--section-bg);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }
    
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
      justify-content: center;
    }
    
    .tool-btn {
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      font-size: 14px;
      padding: 10px 18px;
      cursor: pointer;
      background: color-mix(in srgb, var(--section-bg) 60%, #000);
      color: var(--text-color);
      border: none;
      border-radius: 8px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tool-btn:hover {
      background: color-mix(in srgb, var(--section-bg) 40%, #000);
      transform: translateY(-2px);
    }
    
    .tool-btn.active {
      background: var(--accent-color);
      color: #111;
      box-shadow: 0 4px 12px var(--accent-shadow);
    }
    
    .action-btn {
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      font-size: 15px;
      padding: 12px 24px;
      cursor: pointer;
      background: color-mix(in srgb, var(--section-bg) 60%, #000);
      color: var(--text-color);
      border: 2px solid var(--accent-color);
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    .action-btn:hover {
      background: var(--accent-color);
      color: #111;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px var(--accent-shadow);
    }
    
    .action-btn:active {
      transform: translateY(0);
    }
    
    .controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 20px;
    }
    
    .code-output {
      background: #000;
      color: var(--accent-color);
      text-align: left;
      padding: 20px;
      border-radius: 8px;
      font-family: monospace;
      margin: 20px 0;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.4;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 18px;
      border-radius: 8px;
      z-index: 1000;
      animation: fadeInOut 2s ease-in-out;
      border: 1px solid var(--accent-color);
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-10px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-10px); }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–æ—Å—ã —Å–≤–µ—Ç–æ–¥–∏–æ–¥–æ–≤ */
    .strip-container {
      margin: 0 auto;
      width: max-content;
      max-width: 100%;
      overflow-x: auto;
    }
    
    .strip {
      margin: 20px auto;
      width: max-content;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
      padding: 15px;
      background: var(--section-bg);
      border-radius: 12px;
    }
    
    .row {
      display: flex;
      gap: 3px;
      margin-bottom: 6px;
    }
    
    .led {
      width: 26px;
      height: 26px;
      border-radius: 5px;
      background: color-mix(in srgb, var(--section-bg) 80%, #000);
      cursor: pointer;
      transition: transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      border: 1px solid transparent;
      position: relative;
      color: var(--text-color);
    }
    
    .led:hover {
      transform: scale(1.15);
    }
    
    .led.start {
      background: blue;
      color: white;
    }
    
    .led.finish {
      background: red;
      color: white;
    }
    
    .led.bag {
      background: orange;
      color: white;
    }
    
    .led.path {
      background: yellow;
      color: #111;
    }
    
    .led.hole {
      background: color-mix(in srgb, var(--section-bg) 80%, #000) !important;
      border-width: 2px;
    }
    
    .led.hole-number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 9px;
      font-weight: bold;
      pointer-events: none;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Ä–æ–≤–Ω—è */
    .level-settings {
      display: flex;
      gap: 20px;
      margin-top: 15px;
    }
    
    .setting {
      flex: 1;
    }
    
    label {
      display: block;
      margin: 8px 0 5px;
      color: var(--accent-color);
      font-size: 14px;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px;
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      border-radius: 8px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      font-size: 14px;
    }
    
    textarea {
      min-height: 140px;
      resize: vertical;
    }
    
    .status {
      color: #ff0;
      font-weight: 600;
      margin: 15px 0;
      font-size: 16px;
      text-align: center;
      min-height: 24px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ */
    .visual-controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .visual-control {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--input-bg);
      padding: 10px 18px;
      border-radius: 25px;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    
    .visual-control:hover {
      background: color-mix(in srgb, var(--input-bg) 90%, #000);
      border-color: var(--accent-color);
    }
    
    .visual-control input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      background: color-mix(in srgb, var(--input-bg) 80%, #000);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      transition: all 0.3s;
    }
    
    .visual-control input[type="checkbox"]:checked {
      background: var(--accent-color);
      border-color: var(--accent-color);
    }
    
    .visual-control input[type="checkbox"]:checked::after {
      content: "‚úì";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #111;
      font-weight: bold;
      font-size: 16px;
    }
    
    .visual-control label {
      cursor: pointer;
      color: var(--text-color);
      margin: 0;
      font-size: 14px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ö–µ–º—ã */
    .scheme {
      margin: 20px auto;
      padding: 20px;
      background: var(--section-bg);
      border-radius: 12px;
      max-width: 650px;
    }
    
    .scheme-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      padding: 8px;
      border-radius: 6px;
      background: var(--input-bg);
    }
    
    .scheme-direction {
      font-size: 14px;
      color: var(--accent-color);
    }
    
    .scheme-info {
      font-size: 13px;
      color: color-mix(in srgb, var(--text-color) 60%, transparent);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–µ–≥–µ–Ω–¥—ã */
    .legend-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin: 25px auto;
      max-width: 650px;
    }
    
    .legend-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      background: var(--input-bg);
      padding: 12px;
      border-radius: 10px;
      transition: all 0.3s;
    }
    
    .legend-item:hover {
      background: color-mix(in srgb, var(--input-bg) 90%, #000);
      transform: translateY(-3px);
    }
    
    .legend-color {
      width: 35px;
      height: 35px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: bold;
    }
    
    .legend-text {
      font-size: 13px;
      color: color-mix(in srgb, var(--text-color) 80%, transparent);
      text-align: center;
      line-height: 1.3;
    }
    
    .legend-color.start {
      background: blue;
      color: white;
    }
    
    .legend-color.finish {
      background: red;
      color: white;
    }
    
    .legend-color.bag {
      background: orange;
      color: white;
    }
    
    .legend-color.path {
      background: yellow;
      color: #111;
    }
    
    .legend-color.hole {
      background: color-mix(in srgb, var(--section-bg) 80%, #000);
      border: 2px solid #888;
      color: white;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å–µ—Ç–µ–π */
    .networks-list {
      background: var(--input-bg);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
    }
    
    .network-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding: 8px;
      background: color-mix(in srgb, var(--input-bg) 80%, #000);
      border-radius: 6px;
    }
    
    .network-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid;
    }
    
    .network-info {
      font-size: 13px;
      color: color-mix(in srgb, var(--text-color) 80%, transparent);
    }
    
    /* –ü–æ–¥–≤–∞–ª */
    footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: var(--section-bg);
      color: color-mix(in srgb, var(--text-color) 60%, transparent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      border-top: 1px solid var(--border-color);
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    @media (max-width: 768px) {
      .level-settings {
        flex-direction: column;
      }
      
      .visual-controls {
        flex-direction: column;
        align-items: center;
      }
      
      .legend-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .tab-btn {
        padding: 10px 12px;
        font-size: 13px;
      }
      
      .led {
        width: 22px;
        height: 22px;
      }
      
      .tool-btn {
        padding: 8px 12px;
        font-size: 13px;
      }
    }
    
    /* –ö–Ω–æ–ø–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å —à–µ—Å—Ç–µ—Ä–µ–Ω–∫–æ–π */
    .settings-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: color-mix(in srgb, var(--section-bg) 60%, #000);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .settings-btn:hover .gear-icon {
      transform: rotate(30deg);
    }
    
    .settings-btn:hover {
      background: color-mix(in srgb, var(--section-bg) 40%, #000);
    }
    
    .gear-icon {
      width: 20px;
      height: 20px;
      fill: var(--accent-color);
      transition: transform 0.3s;
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    .settings-modal {
      display: none;
      position: fixed;
      top: 70px;
      right: 20px;
      background: var(--section-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      z-index: 1001;
      width: 300px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    
    .setting-item {
      margin: 15px 0;
    }
    
    .setting-item label {
      display: block;
      margin-bottom: 8px;
      color: var(--accent-color);
      font-size: 14px;
    }
    
    /* –ü–æ–¥–ª–æ–∂–∫–∞ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
    .editor-tools-container {
      background: var(--input-bg);
      border-radius: 12px;
      padding: 20px;
      margin: 15px 0;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã —Å–≤–æ–±–æ–¥–Ω–æ–π —Ä–∞–∑–º–µ—Ç–∫–∏ */
    .free-tool-group {
      position: relative;
      min-width: 200px;
    }
    
    /* –ú–∞–ª–µ–Ω—å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ —Ç—Ä–æ–ø—ã –∏ –º–µ—à–∫–∞ */
    .sub-toolbar {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      justify-content: center;
      flex-wrap: wrap;
      background: rgba(255, 255, 255, 0.05);
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      width: 100%;
    }
    
    .small-tool {
      padding: 6px 12px;
      background: color-mix(in srgb, var(--section-bg) 60%, #000);
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      color: color-mix(in srgb, var(--text-color) 80%, transparent);
      font-weight: 600;
      flex: 1;
      min-width: 70px;
      justify-content: center;
    }
    
    .small-tool:hover {
      background: color-mix(in srgb, var(--section-bg) 40%, #000);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .small-tool.active {
      background: var(--accent-color);
      color: #111;
      border-color: var(--accent-color);
      box-shadow: 0 4px 12px var(--accent-shadow);
    }
    
    /* –ü–æ–ª–∑—É–Ω–∫–∏ –≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–µ */
    .range-sliders {
      display: grid;
      gap: 15px;
      margin: 20px 0;
    }
    
    .slider-container {
      background: var(--input-bg);
      padding: 15px;
      border-radius: 10px;
    }
    
    .slider-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .slider-value {
      color: var(--accent-color);
      font-weight: bold;
    }
    
    input[type="range"] {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      background: color-mix(in srgb, var(--input-bg) 80%, #000);
      border-radius: 4px;
      outline: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: var(--accent-color);
      border-radius: 50%;
      cursor: pointer;
    }
    
    /* –°–ø–æ–π–ª–µ—Ä –¥–ª—è —Ä–µ—à–µ–Ω–∏—è */
    .spoiler {
      margin: 20px 0;
    }
    
    .spoiler-header {
      background: var(--input-bg);
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--border-color);
      transition: all 0.3s;
    }
    
    .spoiler-header:hover {
      background: color-mix(in srgb, var(--input-bg) 90%, #000);
    }
    
    .spoiler-content {
      display: none;
      padding: 20px;
      background: var(--section-bg);
      border-radius: 0 0 8px 8px;
      border: 1px solid var(--border-color);
      border-top: none;
    }
    
    .spoiler.open .spoiler-content {
      display: block;
    }
    
    .spoiler-arrow {
      transition: transform 0.3s;
    }
    
    .spoiler.open .spoiler-arrow {
      transform: rotate(180deg);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —à–∞–≥–æ–≤ —Ä–µ—à–µ–Ω–∏—è */
    .solution-step {
      margin: 12px 0;
      padding-left: 20px;
      border-left: 3px solid var(--accent-color);
      font-size: 14px;
    }
    
    .step-number {
      display: inline-block;
      width: 26px;
      height: 26px;
      background: var(--accent-color);
      color: #111;
      border-radius: 50%;
      text-align: center;
      margin-right: 12px;
      font-weight: bold;
      line-height: 26px;
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ—à–µ–Ω–∏—è —ç–º—É–ª—è—Ç–æ—Ä–∞ */
    .solution-container {
      background: #151515;
      border-radius: 12px;
      padding: 20px;
      margin-top: 25px;
    }
    
    .solution-title {
      color: var(--accent-color);
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ PIN-–∫–æ–¥–æ–º */
    #pinOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 9999;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    #pinOverlay.active {
      display: flex;
    }
    
    .pin-container {
      background: var(--section-bg);
      padding: 40px;
      border-radius: 20px;
      border: 2px solid var(--accent-color);
      max-width: 400px;
      width: 90%;
    }
    
    .pin-title {
      color: var(--accent-color);
      font-size: 24px;
      margin-bottom: 20px;
    }
    
    .pin-input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      text-align: center;
      letter-spacing: 10px;
      background: var(--input-bg);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--accent-color);
      margin-bottom: 20px;
      font-family: monospace;
    }
    
    .pin-input:focus {
      outline: none;
      border-color: var(--accent-color);
    }
    
    .pin-message {
      color: #ff5555;
      margin-top: 10px;
      min-height: 24px;
    }
    
    /* –¶–≤–µ—Ç–Ω—ã–µ –∫—Ä—É–∂–æ—á–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã */
    .theme-colors {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .color-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s;
    }
    
    .color-circle:hover {
      transform: scale(1.1);
    }
    
    .color-circle.selected {
      border-color: white;
      box-shadow: 0 0 0 2px var(--current-color);
    }
  </style>
</head>
<body>
  <h1>MouseGame: –≠–º—É–ª—è—Ç–æ—Ä, –†–µ–¥–∞–∫—Ç–æ—Ä –∏ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω–µ–π</h1>

  <!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è PIN-–∫–æ–¥–∞ -->
  <div id="pinOverlay">
    <div class="pin-container">
      <div class="pin-title">–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥</div>
      <input type="password" class="pin-input" id="pinInput" maxlength="4" pattern="\d*" inputmode="numeric">
      <div class="pin-message" id="pinMessage"></div>
      <button class="action-btn" id="pinSubmit">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
      <div style="margin-top: 20px; color: #888; font-size: 14px;">
        –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0000
      </div>
    </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
  <button class="settings-btn" id="settingsBtn">
    <svg class="gear-icon" viewBox="0 0 24 24">
      <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
    </svg>
  </button>

  <div class="settings-modal" id="settingsModal">
    <h3 style="color: var(--accent-color); margin-top: 0;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    
    <div class="setting-item">
      <label for="solutionSpeed">–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∫–∞–∑–∞ —Ä–µ—à–µ–Ω–∏—è:</label>
      <select id="solutionSpeed">
        <option value="500">–ú–µ–¥–ª–µ–Ω–Ω–æ</option>
        <option value="300" selected>–°—Ä–µ–¥–Ω–µ</option>
        <option value="100">–ë—ã—Å—Ç—Ä–æ</option>
      </select>
    </div>
    
    <div class="setting-item">
      <label>–¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:</label>
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="action-btn" id="themeDark" style="flex: 1;">üåô –¢—ë–º–Ω–∞—è</button>
        <button class="action-btn" id="themeLight" style="flex: 1;">‚òÄ –°–≤–µ—Ç–ª–∞—è</button>
      </div>
    </div>
    
    <div class="setting-item">
      <label>–¶–≤–µ—Ç –∞–∫—Ü–µ–Ω—Ç–æ–≤:</label>
      <div class="theme-colors">
        <div class="color-circle" data-color="#0f8" style="background-color: #0f8;" title="–ó–µ–ª–µ–Ω—ã–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"></div>
        <div class="color-circle" data-color="#ff9900" style="background-color: #ff9900;" title="–û—Ä–∞–Ω–∂–µ–≤—ã–π"></div>
        <div class="color-circle" data-color="#ff3366" style="background-color: #ff3366;" title="–†–æ–∑–æ–≤—ã–π"></div>
        <div class="color-circle" data-color="#3366ff" style="background-color: #3366ff;" title="–°–∏–Ω–∏–π"></div>
        <div class="color-circle" data-color="#9933ff" style="background-color: #9933ff;" title="–§–∏–æ–ª–µ—Ç–æ–≤—ã–π"></div>
        <div class="color-circle" data-color="#00cc99" style="background-color: #00cc99;" title="–ë–∏—Ä—é–∑–æ–≤—ã–π"></div>
      </div>
    </div>
    
    <div class="setting-item">
      <div class="visual-control">
        <input type="checkbox" id="pinLockEnabled">
        <label for="pinLockEnabled">–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ PIN-–∫–æ–¥–æ–º</label>
      </div>
      <div id="pinSettings" style="margin-top: 10px; display: none;">
        <input type="password" id="pinCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π PIN (4 —Ü–∏—Ñ—Ä—ã)" maxlength="4" pattern="\d*" style="width: 100%; margin-bottom: 5px;">
        <div style="color: #888; font-size: 12px;">–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–æ–¥ PIN-–∫–æ–¥–∞</div>
      </div>
    </div>
    
    <button class="action-btn" id="closeSettings" style="width: 100%; margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

  <div class="tabs">
    <button class="tab-btn" data-tab="emulator">–≠–º—É–ª—è—Ç–æ—Ä</button>
    <button class="tab-btn active" data-tab="editor">–†–µ–¥–∞–∫—Ç–æ—Ä</button>
    <button class="tab-btn" data-tab="generator">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</button>
    <button class="tab-btn" data-tab="device">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
  </div>

  <!-- –í–∫–ª–∞–¥–∫–∞ –≠–º—É–ª—è—Ç–æ—Ä–∞ -->
  <div id="emulator" class="tab-content">
    <div class="section">
      <h3 style="color: var(--accent-color); margin-top: 0; text-align: center;">–≠–º—É–ª—è—Ç–æ—Ä –∏–≥—Ä—ã MouseGame</h3>
      <div class="status" id="emulatorStatus">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –∏–≥—Ä—ã</div>
      
      <div class="level-settings">
        <div class="setting">
          <label for="emulatorLevel">–£—Ä–æ–≤–µ–Ω—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</label>
          <select id="emulatorLevel">
            <option value="1">–£—Ä–æ–≤–µ–Ω—å 1 (–õ–µ–≥–∫–∏–π)</option>
            <option value="2">–£—Ä–æ–≤–µ–Ω—å 2 (–°—Ä–µ–¥–Ω–∏–π)</option>
            <option value="3">–£—Ä–æ–≤–µ–Ω—å 3 (–°–ª–æ–∂–Ω—ã–π)</option>
            <option value="custom">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å</option>
          </select>
        </div>
      </div>
      
      <div id="customLevelSection" style="display: none;">
        <div class="setting">
          <label for="emulatorCustomCode">–ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è</label>
          <textarea id="emulatorCustomCode" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ —É—Ä–æ–≤–Ω—è (else if (level == X) { ... })"></textarea>
        </div>
        <div class="controls">
          <button class="action-btn" id="loadEmulatorLevel">–ó–∞–≥—Ä—É–∑–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –≤ —ç–º—É–ª—è—Ç–æ—Ä</button>
        </div>
      </div>
      
      <div class="controls">
        <button class="action-btn" id="emulatorReset">‚Üª –°–±—Ä–æ—Å —É—Ä–æ–≤–Ω—è</button>
        <button class="action-btn" id="emulatorSolution">üîç –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ</button>
      </div>
    </div>
    
    <div class="section">
      <div class="strip-container">
        <div class="strip" id="emulatorStrip"></div>
      </div>
      
      <div class="controls">
        <button class="action-btn" id="emulatorLeft">‚Üê –í–ª–µ–≤–æ</button>
        <button class="action-btn" id="emulatorCenter">–ó–∞–Ω—ã—Ä–Ω—É—Ç—å</button>
        <button class="action-btn" id="emulatorRight">–í–ø—Ä–∞–≤–æ ‚Üí</button>
      </div>
    </div>
    
    <!-- –°–ø–æ–π–ª–µ—Ä —Å —Ä–µ—à–µ–Ω–∏–µ–º -->
    <div class="spoiler" id="emulatorSpoiler">
      <div class="spoiler-header" onclick="toggleSpoiler('emulatorSpoiler')">
        <span>–†–µ—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è</span>
        <span class="spoiler-arrow">‚ñº</span>
      </div>
      <div class="spoiler-content" id="emulatorSolutionContainer">
        <div id="emulatorSolutionSteps"></div>
      </div>
    </div>
  </div>

  <!-- –í–∫–ª–∞–¥–∫–∞ –†–µ–¥–∞–∫—Ç–æ—Ä–∞ -->
  <div id="editor" class="tab-content active">
    <div class="section">
      <h3 style="color: var(--accent-color); margin-top: 0; text-align: center;">–†–µ–¥–∞–∫—Ç–æ—Ä —É—Ä–æ–≤–Ω–µ–π MouseGame</h3>
      
      <div class="editor-tools-container">
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã -->
        <div class="toolbar">
          <button class="tool-btn" data-mode="none">
            <span>‚úñ</span> –ù–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
          </button>
          
          <!-- –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–≤–æ–±–æ–¥–Ω—É—é —Ä–∞–∑–º–µ—Ç–∫—É —Å –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ -->
          <div class="free-tool-group">
            <button class="tool-btn active" data-mode="free" id="freeToolBtn" style="width: 100%;">
              <span>‚úé</span> –°–≤–æ–±–æ–¥–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞
            </button>
            
            <!-- –ú–∞–ª–µ–Ω—å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ —Ç—Ä–æ–ø—ã –∏ –º–µ—à–∫–∞ -->
            <div class="sub-toolbar" style="display: none;">
              <div class="small-tool" data-quick="path" style="color: yellow;">
                <span>T</span> –¢—Ä–æ–ø–∞
              </div>
              <div class="small-tool" data-quick="bag" style="color: orange;">
                <span>M</span> –ú–µ—à–æ–∫
              </div>
            </div>
          </div>
          
          <button class="tool-btn" data-mode="hole">
            <span>üï≥Ô∏è</span> –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ—Ä
          </button>
          <button class="tool-btn" data-mode="select-finish">
            <span>‚öë</span> –í—ã–±—Ä–∞—Ç—å —Ñ–∏–Ω–∏—à
          </button>
          <button class="tool-btn" data-mode="info" style="background: #0080ff;">
            <span>‚Ñπ</span> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
          </button>
          <button class="tool-btn" style="background: #800;" data-action="clear">
            <span>‚å´</span> –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ
          </button>
        </div>
      </div>

      <div class="level-settings">
        <div class="setting">
          <label for="levelNum">–ù–æ–º–µ—Ä —É—Ä–æ–≤–Ω—è</label>
          <input type="number" id="levelNum" min="1" value="3">
        </div>
        <div class="setting">
          <label for="levelName">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è (–∏–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å)</label>
          <input type="text" id="levelName" value="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è">
        </div>
      </div>

      <div class="visual-controls">
        <div class="visual-control">
          <input type="checkbox" id="showAllIndices">
          <label for="showAllIndices">–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤—Å–µ—Ö –∫–ª–µ—Ç–æ–∫ (0-179)</label>
        </div>
        <div class="visual-control">
          <input type="checkbox" id="showHoleIndices">
          <label for="showHoleIndices">–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–æ—Ä (0-179)</label>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="strip-container">
        <div class="strip" id="editorStrip"></div>
      </div>
    </div>

    <div class="section" id="infoPanel" style="display: none;">
      <h3 style="color: var(--accent-color); margin-top: 0;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–µ—Ç–∫–µ</h3>
      <div id="infoDetails" style="font-family: monospace; font-size: 14px; line-height: 1.5;"></div>
    </div>
    
    <div class="section networks-list" id="networksList" style="display: none;">
      <h4 style="color: var(--accent-color); margin-top: 0;">–¢–µ–∫—É—â–∏–µ —Å–µ—Ç–∏ –Ω–æ—Ä:</h4>
      <div id="networksListContent"></div>
    </div>

    <div class="controls">
      <button class="action-btn" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ —É—Ä–æ–≤–Ω—è</button>
      <button class="action-btn" id="exportToEmulatorBtn">–≠–∫—Å–ø–æ—Ä—Ç –≤ —ç–º—É–ª—è—Ç–æ—Ä</button>
      <button class="action-btn" id="copyBtn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä</button>
      <button class="action-btn" id="exportToDeviceBtn">–≠–∫—Å–ø–æ—Ä—Ç –≤ –º–µ–Ω–µ–¥–∂–µ—Ä —É—Ä–æ–≤–Ω–µ–π</button>
    </div>

    <div class="section">
      <div class="code-output" id="codeOutput">
        // –ö–æ–¥ —É—Ä–æ–≤–Ω—è –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ —ç–∫—Å–ø–æ—Ä—Ç–∞
      </div>
    </div>

    <div class="legend-grid">
      <div class="legend-item">
        <div class="legend-color start"></div>
        <div class="legend-text">–°—Ç–∞—Ä—Ç (–ø–æ–∑–∏—Ü–∏—è 0)</div>
      </div>
      <div class="legend-item">
        <div class="legend-color finish"></div>
        <div class="legend-text">–§–∏–Ω–∏—à</div>
      </div>
      <div class="legend-item">
        <div class="legend-color bag"></div>
        <div class="legend-text">–ú–µ—à–æ–∫</div>
      </div>
      <div class="legend-item">
        <div class="legend-color path"></div>
        <div class="legend-text">–¢—Ä–æ–ø–∏–Ω–∫–∞</div>
      </div>
      <div class="legend-item">
        <div class="legend-color hole">1</div>
        <div class="legend-text">–ù–æ—Ä–∞ (–Ω–æ–º–µ—Ä –≤ —Å–µ—Ç–∏)</div>
      </div>
    </div>

    <div class="scheme">
      <h3 style="color: var(--accent-color); margin-top: 0; text-align: center;">–°—Ö–µ–º–∞ –∑–º–µ–π–∫–∏ (180 —Å–≤–µ—Ç–æ–¥–∏–æ–¥–æ–≤)</h3>
      <div class="scheme-row">
        <div class="scheme-direction">‚Üí –°–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ</div>
        <div class="scheme-info">–°—Ç—Ä–æ–∫–∞ 1: —Å–≤–µ—Ç–æ–¥–∏–æ–¥—ã 0-37 (38 —à—Ç)</div>
      </div>
      <div class="scheme-row">
        <div class="scheme-direction">‚Üê –°–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ</div>
        <div class="scheme-info">–°—Ç—Ä–æ–∫–∞ 2: —Å–≤–µ—Ç–æ–¥–∏–æ–¥—ã 38-75 (38 —à—Ç)</div>
      </div>
      <div class="scheme-row">
        <div class="scheme-direction">‚Üí –°–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ</div>
        <div class="scheme-info">–°—Ç—Ä–æ–∫–∞ 3: —Å–≤–µ—Ç–æ–¥–∏–æ–¥—ã 76-113 (38 —à—Ç)</div>
      </div>
      <div class="scheme-row">
        <div class="scheme-direction">‚Üê –°–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ</div>
        <div class="scheme-info">–°—Ç—Ä–æ–∫–∞ 4: —Å–≤–µ—Ç–æ–¥–∏–æ–¥—ã 114-151 (38 —à—Ç)</div>
      </div>
      <div class="scheme-row">
        <div class="scheme-direction">‚Üí –°–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ</div>
        <div class="scheme-info">–°—Ç—Ä–æ–∫–∞ 5: —Å–≤–µ—Ç–æ–¥–∏–æ–¥—ã 152-179 (28 —à—Ç)</div>
      </div>
    </div>
  </div>

  <!-- –í–∫–ª–∞–¥–∫–∞ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ -->
  <div id="generator" class="tab-content">
    <div class="section">
      <h3 style="color: var(--accent-color); margin-top: 0; text-align: center;">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω–µ–π MouseGame</h3>
      
      <div class="level-settings">
        <div class="setting">
          <label for="generatorLevelNum">–ù–æ–º–µ—Ä —É—Ä–æ–≤–Ω—è</label>
          <input type="number" id="generatorLevelNum" min="1" value="6">
        </div>
        <div class="setting">
          <label for="generatorLevelName">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è (–∏–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å)</label>
          <input type="text" id="generatorLevelName" value="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è">
        </div>
      </div>
      
      <div class="range-sliders">
        <div class="slider-container">
          <div class="slider-label">
            <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–æ–ø</span>
            <span class="slider-value" id="pathCountValue">3</span>
          </div>
          <input type="range" min="0" max="10" value="3" class="slider" id="pathCountSlider">
        </div>
        
        <div class="slider-container">
          <div class="slider-label">
            <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—à–∫–æ–≤</span>
            <span class="slider-value" id="bagCountValue">5</span>
          </div>
          <input type="range" min="0" max="20" value="5" class="slider" id="bagCountSlider">
        </div>
        
        <div class="slider-container">
          <div class="slider-label">
            <span>–ù–æ—Ä –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏</span>
            <span class="slider-value" id="holePerNetworkValue">3</span>
          </div>
          <input type="range" min="2" max="8" value="3" class="slider" id="holePerNetworkSlider">
        </div>
        
        <div class="slider-container">
          <div class="slider-label">
            <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ç–µ–π –Ω–æ—Ä</span>
            <span class="slider-value" id="networkCountValue">4</span>
          </div>
          <input type="range" min="1" max="10" value="4" class="slider" id="networkCountSlider">
        </div>
      </div>
      
      <div class="status" id="generatorStatus">–ì–æ—Ç–æ–≤ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω–µ–π</div>
      
      <div class="controls">
        <button class="action-btn" id="generateBtn">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å</button>
        <button class="action-btn" id="generatorCopyBtn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
        <button class="action-btn" id="generatorLoadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä</button>
        <button class="action-btn" id="generatorLoadEmulatorBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ —ç–º—É–ª—è—Ç–æ—Ä</button>
        <button class="action-btn" id="generatorExportToDeviceBtn">–≠–∫—Å–ø–æ—Ä—Ç –≤ –º–µ–Ω–µ–¥–∂–µ—Ä</button>
      </div>
    </div>
    
    <div class="section">
      <h3 style="color: var(--accent-color); margin-top: 0; margin-bottom: 15px;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —É—Ä–æ–≤–Ω—è</h3>
      <div class="strip-container">
        <div class="strip" id="generatorStrip"></div>
      </div>
    </div>
    
    <div class="section">
      <h3 style="color: var(--accent-color); margin-top: 0; margin-bottom: 15px;">–ö–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è</h3>
      <div class="code-output" id="generatorCodeOutput">
        // –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å
      </div>
    </div>
    
    <div class="section">
      <div class="spoiler" id="generatorSpoiler">
        <div class="spoiler-header" onclick="toggleSpoiler('generatorSpoiler')">
          <span>–ö–∞–∫ –ø—Ä–æ–π—Ç–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å:</span>
          <span class="spoiler-arrow">‚ñº</span>
        </div>
        <div class="spoiler-content">
          <div id="generatorSolutionSteps">
            <p>–†–µ—à–µ–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω—è</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –í–∫–ª–∞–¥–∫–∞ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
  <div id="device" class="tab-content">
    <div class="section">
      <h3 style="color: var(--accent-color); margin-top: 0; text-align: center;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è–º–∏ –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h3>
      
      <div class="toolbar">
        <button class="action-btn" id="importLevelsBtn">üìÅ –ò–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞ levels.h</button>
        <button class="action-btn" id="exportLevelsBtn">üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤ levels.h</button>
        <button class="action-btn" id="refreshLevelsBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
      </div>
      
      <div class="status" id="deviceStatus">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª levels.h –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —É—Ä–æ–≤–Ω–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ</div>
      
      <div class="level-settings">
        <div class="setting">
          <label for="maxLevels">–ú–∞–∫—Å. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π –≤ —Ñ–∞–π–ª–µ:</label>
          <input type="number" id="maxLevels" min="1" max="100" value="50">
        </div>
      </div>
      
      <div class="section" id="levelsListContainer" style="display: none;">
        <h4 style="color: var(--accent-color);">–°–ø–∏—Å–æ–∫ —É—Ä–æ–≤–Ω–µ–π:</h4>
        <div id="levelsList" style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
          <!-- –£—Ä–æ–≤–Ω–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
        </div>
      </div>
      
      <div class="section">
        <h4 style="color: var(--accent-color);">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–∞ levels.h:</h4>
        <div class="code-output" id="levelsPreview" style="font-size: 11px; line-height: 1.2;">
          // –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —É—Ä–æ–≤–Ω–∏
        </div>
      </div>
      
      <div class="controls">
        <button class="action-btn" id="saveLevelsBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª</button>
        <button class="action-btn" id="clearLevelsBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —É—Ä–æ–≤–Ω–∏</button>
      </div>
    </div>
    
    <div class="section">
      <h3 style="color: var(--accent-color); margin-top: 0;">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3>
      <div style="text-align: left; line-height: 1.5;">
        <p>1. –°–æ–∑–¥–∞–π—Ç–µ —É—Ä–æ–≤–Ω–∏ –≤ <strong>–†–µ–¥–∞–∫—Ç–æ—Ä–µ</strong> –∏–ª–∏ <strong>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä–µ</strong></p>
        <p>2. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —É—Ä–æ–≤–Ω–∏ –≤ –º–µ–Ω–µ–¥–∂–µ—Ä –∫–Ω–æ–ø–∫–æ–π "–≠–∫—Å–ø–æ—Ä—Ç –≤ –º–µ–Ω–µ–¥–∂–µ—Ä —É—Ä–æ–≤–Ω–µ–π"</p>
        <p>3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª levels.h (–µ—Å–ª–∏ –µ—Å—Ç—å) –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
        <p>4. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —É—Ä–æ–≤–Ω–∏: –∏–∑–º–µ–Ω–∏—Ç–µ –ø–æ—Ä—è–¥–æ–∫, –Ω–∞–∑–≤–∞–Ω–∏—è, —Å–ª–æ–∂–Ω–æ—Å—Ç—å</p>
        <p>5. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª levels.h –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ Arduino</p>
      </div>
    </div>
  </div>

  <footer>
    <div>–¢–∏–º–æ—Ñ–µ–π –õ—é–±—É—à–∫–∏–Ω, 2026</div>
  </footer>

  <script>
    // =============================================
    // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    // =============================================
    
    const NUM_LEDS = 180;
    const TOTAL_ROWS = 5;
    const ROWS = [
      { start: 0,   count: 38 },
      { start: 38,  count: 38 },
      { start: 76,  count: 38 },
      { start: 114, count: 38 },
      { start: 152, count: 28 }
    ];

    // –¢–∏–ø—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const ELEMENT_TYPES = {
      EMPTY: 180,
      START: 181,
      FINISH: 182,
      BAG: 183,
      PATH: 185,
      HOLE: 179
    };

    // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è —Å–µ—Ç–µ–π –Ω–æ—Ä (24 —Ü–≤–µ—Ç–∞)
    const NETWORK_COLORS = [
      '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF',
      '#FF8000', '#8000FF', '#0080FF', '#FF0080', '#80FF00', '#008080',
      '#FF3333', '#33FF33', '#3333FF', '#FFFF33', '#FF33FF', '#33FFFF',
      '#FF9933', '#9933FF', '#3399FF', '#FF3399', '#99FF33', '#33FF99'
    ];

    // =============================================
    // –ù–û–í–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –ò PIN-–ö–û–î
    // =============================================

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let appSettings = {
      theme: 'dark',
      accentColor: '#0f8',
      pinLockEnabled: false,
      pinCode: '0000',
      solutionSpeed: 300
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ localStorage
    function loadSettings() {
      const saved = localStorage.getItem('mousegame_settings');
      if (saved) {
        appSettings = { ...appSettings, ...JSON.parse(saved) };
      }
      applySettings();
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    function saveSettings() {
      localStorage.setItem('mousegame_settings', JSON.stringify(appSettings));
      applySettings();
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    function applySettings() {
      // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
      if (appSettings.theme === 'light') {
        document.body.classList.add('light-theme');
      } else {
        document.body.classList.remove('light-theme');
      }
      
      // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –∞–∫—Ü–µ–Ω—Ç–æ–≤
      document.documentElement.style.setProperty('--accent-color', appSettings.accentColor);
      
      // –°–æ–∑–¥–∞–µ–º –±–æ–ª–µ–µ —Ç–µ–º–Ω—É—é –≤–µ—Ä—Å–∏—é –¥–ª—è —Ç–µ–Ω–∏
      const rgb = hexToRgb(appSettings.accentColor);
      const shadowColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.3)`;
      document.documentElement.style.setProperty('--accent-shadow', shadowColor);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
      updateColorSelector();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
      const solutionSpeedSelect = document.getElementById('solutionSpeed');
      if (solutionSpeedSelect) {
        solutionSpeedSelect.value = appSettings.solutionSpeed;
      }
    }

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ HEX –≤ RGB
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : { r: 0, g: 0, b: 0 };
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
    function updateColorSelector() {
      const circles = document.querySelectorAll('.color-circle');
      circles.forEach(circle => {
        circle.classList.remove('selected');
        if (circle.dataset.color === appSettings.accentColor) {
          circle.classList.add('selected');
          circle.style.setProperty('--current-color', appSettings.accentColor);
        }
      });
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É PIN-–∫–æ–¥–æ–º
    function showPinLock() {
      const overlay = document.getElementById('pinOverlay');
      overlay.classList.add('active');
      document.getElementById('pinInput').value = '';
      document.getElementById('pinMessage').textContent = '';
      document.getElementById('pinInput').focus();
    }

    // –°–∫—Ä—ã—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É PIN-–∫–æ–¥–æ–º
    function hidePinLock() {
      document.getElementById('pinOverlay').classList.remove('active');
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ PIN-–∫–æ–¥–∞
    function checkPinCode(input) {
      return input === appSettings.pinCode;
    }

    // =============================================
    // –§–£–ù–ö–¶–ò–ò –û–ë–©–ï–ì–û –ù–ê–ó–ù–ê–ß–ï–ù–ò–Ø
    // =============================================

    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 2000);
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Ü–≤–µ—Ç –¥–ª—è —Å–µ—Ç–∏ –ø–æ –∏–Ω–¥–µ–∫—Å—É
    function getNetworkColor(networkIndex) {
      return NETWORK_COLORS[networkIndex % NETWORK_COLORS.length];
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–æ–∫—É –ø–æ –ø–æ–∑–∏—Ü–∏–∏
    function getRow(pos) {
      if (pos < 38) return 0;
      if (pos < 76) return 1;
      if (pos < 114) return 2;
      if (pos < 152) return 3;
      return 4;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–ø–æ–π–ª–µ—Ä–∞
    function toggleSpoiler(spoilerId) {
      const spoiler = document.getElementById(spoilerId);
      spoiler.classList.toggle('open');
    }

    // =============================================
    // –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–ö–õ–ê–î–ö–ê–ú–ò –ò –ù–ê–°–¢–†–û–ô–ö–ê–ú–ò
    // =============================================

    document.addEventListener('DOMContentLoaded', function() {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      loadSettings();
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ PIN-–∫–æ–¥–æ–º
      if (appSettings.pinLockEnabled) {
        showPinLock();
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tabId = button.dataset.tab;
          
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          button.classList.add('active');
          document.getElementById(tabId).classList.add('active');
          
          document.getElementById('settingsModal').style.display = 'none';
          
          if (tabId === 'editor') {
            updateVisuals();
            updateNetworksList();
          }
          
          if (tabId === 'emulator') {
            updateEmulatorDisplay();
          }
          
          if (tabId === 'generator') {
            updateGeneratorDisplay();
          }
          
          if (tabId === 'device') {
            updateLevelsList();
            updateLevelsPreview();
          }
        });
      });
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
      initEditor();
      initEmulator();
      initGenerator();
      initSmallTools();
      initGeneratorSliders();
      initSettings();
      initDeviceManager();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–æ—Ä –≤ –ª–µ–≥–µ–Ω–¥–µ
      const holeLegend = document.querySelector('.legend-text');
      if (holeLegend && holeLegend.textContent.includes('—Ü–∏—Ñ—Ä–∞ - –Ω–æ–º–µ—Ä –≤ —Å–µ—Ç–∏')) {
        holeLegend.textContent = '–ù–æ—Ä–∞ (–Ω–æ–º–µ—Ä –≤ —Å–µ—Ç–∏)';
      }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
    function initSettings() {
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsModal = document.getElementById('settingsModal');
      const closeSettings = document.getElementById('closeSettings');
      
      if (settingsBtn && settingsModal && closeSettings) {
        settingsBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          settingsModal.style.display = settingsModal.style.display === 'block' ? 'none' : 'block';
        });
        
        closeSettings.addEventListener('click', function() {
          settingsModal.style.display = 'none';
        });
        
        document.addEventListener('click', function(event) {
          if (!settingsModal.contains(event.target) && 
              !settingsBtn.contains(event.target) &&
              settingsModal.style.display === 'block') {
            settingsModal.style.display = 'none';
          }
        });
      }
      
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º—ã
      document.getElementById('themeDark').addEventListener('click', function() {
        appSettings.theme = 'dark';
        saveSettings();
      });
      
      document.getElementById('themeLight').addEventListener('click', function() {
        appSettings.theme = 'light';
        saveSettings();
      });
      
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–≤–µ—Ç–∞
      document.querySelectorAll('.color-circle').forEach(circle => {
        circle.addEventListener('click', function() {
          appSettings.accentColor = this.dataset.color;
          saveSettings();
        });
      });
      
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ PIN-–∫–æ–¥–∞
      document.getElementById('pinLockEnabled').addEventListener('change', function() {
        appSettings.pinLockEnabled = this.checked;
        document.getElementById('pinSettings').style.display = this.checked ? 'block' : 'none';
        saveSettings();
      });
      
      document.getElementById('pinCode').addEventListener('input', function() {
        if (this.value.length === 4 && /^\d+$/.test(this.value)) {
          appSettings.pinCode = this.value;
          saveSettings();
          showNotification('PIN-–∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω');
        }
      });
      
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ä–µ—à–µ–Ω–∏—è
      document.getElementById('solutionSpeed').addEventListener('change', function() {
        appSettings.solutionSpeed = this.value;
        saveSettings();
      });
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ PIN-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
      document.getElementById('pinLockEnabled').checked = appSettings.pinLockEnabled;
      document.getElementById('pinSettings').style.display = appSettings.pinLockEnabled ? 'block' : 'none';
      document.getElementById('pinCode').value = appSettings.pinCode;
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ PIN-–≤–≤–æ–¥–∞
      document.getElementById('pinSubmit').addEventListener('click', function() {
        const input = document.getElementById('pinInput').value;
        if (checkPinCode(input)) {
          hidePinLock();
        } else {
          document.getElementById('pinMessage').textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥';
          document.getElementById('pinInput').value = '';
          document.getElementById('pinInput').focus();
        }
      });
      
      document.getElementById('pinInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('pinSubmit').click();
        }
      });
    }

    // =============================================
    // –†–ï–î–ê–ö–¢–û–† –£–†–û–í–ù–ï–ô
    // =============================================

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    let networks = new Array(NUM_LEDS).fill(ELEMENT_TYPES.EMPTY);
    let currentMode = 'free';
    let holeNetwork = [];
    let holeNetworks = [];
    let finishPos = 179;
    let showAllIndices = false;
    let showHoleIndices = false;
    let currentQuickTool = null;
    
    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    const editorStripEl = document.getElementById('editorStrip');
    const codeOutput = document.getElementById('codeOutput');
    const exportBtn = document.getElementById('exportBtn');
    const exportToEmulatorBtn = document.getElementById('exportToEmulatorBtn');
    const copyBtn = document.getElementById('copyBtn');
    const exportToDeviceBtn = document.getElementById('exportToDeviceBtn');
    const toolButtons = document.querySelectorAll('.toolbar .tool-btn');
    const smallTools = document.querySelectorAll('.small-tool');
    const infoPanel = document.getElementById('infoPanel');
    const infoDetails = document.getElementById('infoDetails');
    const showAllIndicesCheckbox = document.getElementById('showAllIndices');
    const showHoleIndicesCheckbox = document.getElementById('showHoleIndices');
    const networksList = document.getElementById('networksList');
    const networksListContent = document.getElementById('networksListContent');

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    function initEditor() {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: —Å—Ç–∞—Ä—Ç –≤—Å–µ–≥–¥–∞ –≤ –ø–æ–∑–∏—Ü–∏–∏ 0
      networks[0] = ELEMENT_TYPES.START;
      finishPos = 179;
      networks[finishPos] = ELEMENT_TYPES.FINISH;
      
      // –°–æ–∑–¥–∞–Ω–∏–µ –ª–µ–Ω—Ç—ã
      createEditorStrip();
      
      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      updateToolButtons();
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
      toolButtons.forEach(btn => {
        if (btn.dataset.mode) {
          btn.addEventListener('click', () => {
            setMode(btn.dataset.mode);
          });
        }
        if (btn.dataset.action === 'clear') {
          btn.addEventListener('click', clearField);
        }
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π –∏–Ω–¥–µ–∫—Å–æ–≤
      showAllIndicesCheckbox.addEventListener('change', toggleAllIndices);
      showHoleIndicesCheckbox.addEventListener('change', toggleHoleIndices);
      
      // –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–¥–∞
      exportBtn.addEventListener('click', () => {
        const code = generateLevelCode();
        codeOutput.textContent = code;
        showNotification('–ö–æ–¥ —É—Ä–æ–≤–Ω—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω');
      });
      
      // –≠–∫—Å–ø–æ—Ä—Ç –≤ —ç–º—É–ª—è—Ç–æ—Ä
      exportToEmulatorBtn.addEventListener('click', function() {
        const code = generateLevelCode();
        if (code.includes('// –û—à–∏–±–∫–∞')) {
          showNotification('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å');
          return;
        }
        
        document.querySelector('[data-tab="emulator"]').click();
        
        document.getElementById('emulatorLevel').value = 'custom';
        document.getElementById('customLevelSection').style.display = 'block';
        document.getElementById('emulatorCustomCode').value = code;
        
        loadCustomLevelToEmulator();
        
        showNotification('–£—Ä–æ–≤–µ–Ω—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ —ç–º—É–ª—è—Ç–æ—Ä');
      });
      
      // –≠–∫—Å–ø–æ—Ä—Ç –≤ –º–µ–Ω–µ–¥–∂–µ—Ä —É—Ä–æ–≤–Ω–µ–π
      exportToDeviceBtn.addEventListener('click', function() {
        const code = generateLevelCode();
        if (code.includes('// –û—à–∏–±–∫–∞')) {
          showNotification('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å');
          return;
        }
        
        const levelName = document.getElementById('levelName').value;
        const levelNum = document.getElementById('levelNum').value;
        
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–≤—å—é –¥–∞–Ω–Ω—ã—Ö
        const previewData = {
          networks: [...networks],
          finishPos: finishPos,
          holeNetworks: [...holeNetworks]
        };
        
        addLevelToManager(code, levelName, previewData);
        document.querySelector('[data-tab="device"]').click();
      });
      
      // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä
      copyBtn.addEventListener('click', () => {
        const text = codeOutput.textContent;
        if (!text || text.includes('// –û—à–∏–±–∫–∞')) {
          showNotification('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–æ–¥ —É—Ä–æ–≤–Ω—è');
          return;
        }
        
        navigator.clipboard.writeText(text).then(() => {
          const originalText = copyBtn.textContent;
          copyBtn.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
          setTimeout(() => {
            copyBtn.textContent = originalText;
          }, 2000);
          showNotification('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
        });
      });
      
      updateVisuals();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞–ª–µ–Ω—å–∫–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    function initSmallTools() {
      smallTools.forEach(tool => {
        tool.addEventListener('click', () => {
          const toolType = tool.dataset.quick;
          
          if (currentQuickTool === toolType) {
            currentQuickTool = null;
            tool.classList.remove('active');
            setMode('free');
            updateVisuals();
          } else {
            currentQuickTool = toolType;
            smallTools.forEach(t => t.classList.remove('active'));
            tool.classList.add('active');
            
            setMode('free');
            updateVisuals();
          }
        });
      });
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –ª–µ–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    function createEditorStrip() {
      editorStripEl.innerHTML = '';
      
      ROWS.forEach((row, rowIndex) => {
        const rowEl = document.createElement('div');
        rowEl.className = 'row';
        
        const isReversed = rowIndex % 2 === 1;
        
        let indices = [];
        for (let i = row.start; i < row.start + row.count; i++) {
          indices.push(i);
        }
        
        if (isReversed) {
          indices.reverse();
        }
        
        indices.forEach(index => {
          const led = document.createElement('div');
          led.className = 'led';
          led.id = `editor-led-${index}`;
          
          const numberEl = document.createElement('div');
          numberEl.className = 'led-hole-number';
          led.appendChild(numberEl);
          
          if (index === 0) led.classList.add('start');
          if (index === finishPos) led.classList.add('finish');
          
          led.addEventListener('click', () => handleLedClick(index));
          
          rowEl.appendChild(led);
        });
        
        editorStripEl.appendChild(rowEl);
      });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    function updateVisuals() {
      for (let i = 0; i < NUM_LEDS; i++) {
        const led = document.getElementById(`editor-led-${i}`);
        if (!led) continue;
        
        const numberEl = led.querySelector('.led-hole-number');
        
        led.classList.remove('start', 'finish', 'bag', 'path', 'hole', 'editing');
        led.style.borderColor = 'transparent';
        led.style.backgroundColor = '';
        led.style.opacity = '1';
        if (numberEl) {
          numberEl.textContent = '';
          numberEl.style.color = '#fff';
        }
        
        if (currentQuickTool === 'path') {
          if (networks[i] !== ELEMENT_TYPES.PATH && i !== 0 && i !== finishPos) {
            led.style.opacity = '0.3';
          }
        } else if (currentQuickTool === 'bag') {
          if (networks[i] !== ELEMENT_TYPES.BAG && i !== 0 && i !== finishPos) {
            led.style.opacity = '0.3';
          }
        }
        
        if (i === 0) {
          led.classList.add('start');
          led.style.backgroundColor = 'blue';
        } else if (i === finishPos) {
          led.classList.add('finish');
          led.style.backgroundColor = 'red';
        } else if (networks[i] === ELEMENT_TYPES.BAG) {
          led.classList.add('bag');
          led.style.backgroundColor = 'orange';
        } else if (networks[i] === ELEMENT_TYPES.PATH) {
          led.classList.add('path');
          led.style.backgroundColor = 'yellow';
          numberEl.style.color = '#111';
        } else if (networks[i] < 180) {
          led.classList.add('hole');
          led.style.backgroundColor = '#222';
          
          let foundNetwork = null;
          let holeIndex = -1;
          
          for (let n = 0; n < holeNetworks.length; n++) {
            const network = holeNetworks[n];
            const index = network.indexOf(i);
            if (index !== -1) {
              foundNetwork = n;
              holeIndex = index;
              break;
            }
          }
          
          if (foundNetwork === null && currentMode === 'hole') {
            const index = holeNetwork.indexOf(i);
            if (index !== -1) {
              foundNetwork = holeNetworks.length;
              holeIndex = index;
            }
          }
          
          if (foundNetwork !== null) {
            const color = getNetworkColor(foundNetwork);
            led.style.borderColor = color;
            led.style.borderWidth = '2px';
            led.style.borderStyle = 'solid';
          }
        }
        
        if (showAllIndices) {
          if (numberEl) {
            numberEl.textContent = i;
            if (i === 0) {
              numberEl.style.color = 'white';
            } else if (i === finishPos) {
              numberEl.style.color = 'white';
            } else if (networks[i] === ELEMENT_TYPES.BAG) {
              numberEl.style.color = 'white';
            } else if (networks[i] === ELEMENT_TYPES.PATH) {
              numberEl.style.color = '#111';
            } else if (networks[i] < 180) {
              numberEl.style.color = '#fff';
            } else {
              numberEl.style.color = '#888';
            }
          }
        } else if (showHoleIndices && networks[i] < 180) {
          if (numberEl) {
            numberEl.textContent = i;
            numberEl.style.color = '#fff';
          }
        } else if (networks[i] < 180) {
          if (numberEl) {
            let foundNetwork = null;
            let holeIndex = -1;
            
            for (let n = 0; n < holeNetworks.length; n++) {
              const network = holeNetworks[n];
              const index = network.indexOf(i);
              if (index !== -1) {
                foundNetwork = n;
                holeIndex = index;
                break;
              }
            }
            
            if (foundNetwork === null && currentMode === 'hole') {
              const index = holeNetwork.indexOf(i);
              if (index !== -1) {
                foundNetwork = holeNetworks.length;
                holeIndex = index;
              }
            }
            
            if (holeIndex !== -1) {
              numberEl.textContent = holeIndex + 1;
              numberEl.style.color = '#fff';
            }
          }
        }
        
        if (currentMode === 'hole' && holeNetwork.includes(i)) {
          led.classList.add('editing');
          const index = holeNetwork.indexOf(i);
          if (index !== -1 && numberEl) {
            if (showAllIndices) {
              numberEl.textContent = i;
              numberEl.style.color = NETWORK_COLORS[holeNetworks.length % NETWORK_COLORS.length];
            } else if (showHoleIndices) {
              numberEl.textContent = i;
              numberEl.style.color = NETWORK_COLORS[holeNetworks.length % NETWORK_COLORS.length];
            } else {
              numberEl.textContent = index + 1;
              numberEl.style.color = NETWORK_COLORS[holeNetworks.length % NETWORK_COLORS.length];
            }
          }
        }
      }
      
      updateNetworksList();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Ç–µ–π
    function updateNetworksList() {
      if (holeNetworks.length === 0) {
        networksList.style.display = 'none';
        return;
      }
      
      networksList.style.display = 'block';
      networksListContent.innerHTML = '';
      
      holeNetworks.forEach((network, index) => {
        const networkItem = document.createElement('div');
        networkItem.className = 'network-item';
        networkItem.innerHTML = `
          <div class="network-color" style="border-color: ${getNetworkColor(index)}; background: ${getNetworkColor(index)}20;"></div>
          <div class="network-info">–°–µ—Ç—å ${index + 1}: ${network.length} –Ω–æ—Ä(—ã), –ø–æ–∑–∏—Ü–∏–∏: ${network.join(', ')}</div>
        `;
        networksListContent.appendChild(networkItem);
      });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —Å–≤–µ—Ç–æ–¥–∏–æ–¥—É –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
    function handleLedClick(pos) {
      if (pos === 0 && currentMode !== 'info' && currentMode !== 'select-finish') return;
      
      if (currentQuickTool === 'path') {
        if (pos !== 0 && pos !== finishPos) {
          if (networks[pos] < 180) {
            removeHoleFromNetworks(pos);
          }
          
          if (networks[pos] === ELEMENT_TYPES.BAG) {
            networks[pos] = ELEMENT_TYPES.EMPTY;
          }
          
          if (networks[pos] === ELEMENT_TYPES.PATH) {
            networks[pos] = ELEMENT_TYPES.EMPTY;
          } else {
            networks[pos] = ELEMENT_TYPES.PATH;
          }
        }
      } else if (currentQuickTool === 'bag') {
        if (pos !== 0 && pos !== finishPos) {
          if (networks[pos] < 180) {
            removeHoleFromNetworks(pos);
          }
          
          if (networks[pos] === ELEMENT_TYPES.PATH) {
            networks[pos] = ELEMENT_TYPES.EMPTY;
          }
          
          if (networks[pos] === ELEMENT_TYPES.BAG) {
            networks[pos] = ELEMENT_TYPES.EMPTY;
          } else {
            networks[pos] = ELEMENT_TYPES.BAG;
          }
        }
      } else {
        switch (currentMode) {
          case 'free':
            cycleElementType(pos);
            break;
          case 'hole':
            addToHoleNetwork(pos);
            break;
          case 'select-finish':
            setFinishPosition(pos);
            break;
          case 'info':
            showLedInfo(pos);
            break;
        }
      }
      
      updateVisuals();
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ (–≤ —Å–≤–æ–±–æ–¥–Ω–æ–º —Ä–µ–∂–∏–º–µ)
    function cycleElementType(pos) {
      if (pos === finishPos) {
        networks[pos] = ELEMENT_TYPES.EMPTY;
        finishPos = -1;
      }
      
      if (networks[pos] < 180) {
        removeHoleFromNetworks(pos);
      }
      
      switch (networks[pos]) {
        case ELEMENT_TYPES.EMPTY:
          networks[pos] = ELEMENT_TYPES.BAG;
          break;
        case ELEMENT_TYPES.BAG:
          networks[pos] = ELEMENT_TYPES.PATH;
          break;
        case ELEMENT_TYPES.PATH:
          if (finishPos === -1) {
            networks[pos] = ELEMENT_TYPES.FINISH;
            finishPos = pos;
          } else {
            networks[pos] = ELEMENT_TYPES.EMPTY;
          }
          break;
        default:
          networks[pos] = ELEMENT_TYPES.EMPTY;
      }
    }

    // –£–¥–∞–ª–∏—Ç—å –Ω–æ—Ä—É –∏–∑ –≤—Å–µ—Ö —Å–µ—Ç–µ–π
    function removeHoleFromNetworks(pos) {
      for (let i = 0; i < holeNetworks.length; i++) {
        const index = holeNetworks[i].indexOf(pos);
        if (index !== -1) {
          holeNetworks[i].splice(index, 1);
          
          if (holeNetworks[i].length < 2) {
            holeNetworks.splice(i, 1);
            i--;
          }
        }
      }
      
      const index = holeNetwork.indexOf(pos);
      if (index !== -1) {
        holeNetwork.splice(index, 1);
      }
      
      networks[pos] = ELEMENT_TYPES.EMPTY;
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —Å–µ—Ç—å –Ω–æ—Ä
    function addToHoleNetwork(pos) {
      if (pos === finishPos || pos === 0) return;
      
      const index = holeNetwork.indexOf(pos);
      if (index !== -1) {
        holeNetwork.splice(index, 1);
        networks[pos] = ELEMENT_TYPES.EMPTY;
      } else {
        holeNetwork.push(pos);
        networks[pos] = ELEMENT_TYPES.HOLE;
      }
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∏–Ω–∏—à–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
    function setFinishPosition(pos) {
      if (pos === 0) return;
      
      if (finishPos !== -1 && finishPos < NUM_LEDS) {
        networks[finishPos] = ELEMENT_TYPES.EMPTY;
      }
      
      finishPos = pos;
      networks[pos] = ELEMENT_TYPES.FINISH;
      
      setMode('free');
      updateToolButtons();
      showNotification('–§–∏–Ω–∏—à —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–æ–∑–∏—Ü–∏—é ' + pos);
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–∂–∏–º–∞
    function setMode(mode) {
      if (currentMode === 'hole' && mode !== 'hole' && holeNetwork.length > 1) {
        const holeCount = holeNetwork.length;
        saveHoleNetwork();
        showNotification(`–°–æ–∑–¥–∞–Ω–∞ —Å–µ—Ç—å –Ω–æ—Ä –∏–∑ ${holeCount} –æ—Ç–≤–µ—Ä—Å—Ç–∏–π`);
      } else if (currentMode === 'hole' && mode !== 'hole') {
        holeNetwork.forEach(pos => {
          networks[pos] = ELEMENT_TYPES.EMPTY;
        });
        holeNetwork = [];
      }
      
      if (currentMode === 'info' && mode !== 'info') {
        infoPanel.style.display = 'none';
      }
      
      currentMode = mode;
      
      const subToolbar = document.querySelector('.sub-toolbar');
      const freeToolBtn = document.getElementById('freeToolBtn');
      
      if (subToolbar && freeToolBtn) {
        if (mode === 'free') {
          subToolbar.style.display = 'flex';
          freeToolBtn.classList.add('active');
        } else {
          subToolbar.style.display = 'none';
          freeToolBtn.classList.remove('active');
          currentQuickTool = null;
          smallTools.forEach(t => t.classList.remove('active'));
        }
      }
      
      updateToolButtons();
      updateVisuals();
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Ç–∏ –Ω–æ—Ä
    function saveHoleNetwork() {
      if (holeNetwork.length < 2) return;
      
      holeNetworks.push([...holeNetwork]);
      
      for (let i = 0; i < holeNetwork.length; i++) {
        const current = holeNetwork[i];
        const next = holeNetwork[(i + 1) % holeNetwork.length];
        networks[current] = next;
      }
      
      holeNetwork = [];
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —Ä–µ–∂–∏–º–æ–≤
    function updateToolButtons() {
      toolButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.mode === currentMode) {
          btn.classList.add('active');
        }
      });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤ –≤—Å–µ—Ö –∫–ª–µ—Ç–æ–∫
    function toggleAllIndices() {
      showAllIndices = showAllIndicesCheckbox.checked;
      if (showAllIndices) {
        showHoleIndices = false;
        showHoleIndicesCheckbox.checked = false;
      }
      updateVisuals();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–æ—Ä
    function toggleHoleIndices() {
      showHoleIndices = showHoleIndicesCheckbox.checked;
      if (showHoleIndices && showAllIndices) {
        showAllIndices = false;
        showAllIndicesCheckbox.checked = false;
      }
      updateVisuals();
    }

    // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è
    function clearField() {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ? –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
        return;
      }
      
      networks = new Array(NUM_LEDS).fill(ELEMENT_TYPES.EMPTY);
      networks[0] = ELEMENT_TYPES.START;
      finishPos = 179;
      networks[finishPos] = ELEMENT_TYPES.FINISH;
      holeNetwork = [];
      holeNetworks = [];
      currentQuickTool = null;
      smallTools.forEach(t => t.classList.remove('active'));
      infoPanel.style.display = 'none';
      updateVisuals();
      showNotification('–ü–æ–ª–µ –æ—á–∏—â–µ–Ω–æ');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–æ—Ä–µ
    function updateHoleInfo(pos) {
      if (networks[pos] < 180 && networks[pos] >= 0) {
        let network = [];
        let visited = new Set();
        let current = pos;
        
        while (!visited.has(current)) {
          visited.add(current);
          network.push(current);
          current = networks[current];
        }
        
        if (network.length > 1) {
          let orderedNetwork = [];
          current = pos;
          
          while (true) {
            let found = false;
            for (let i = 0; i < NUM_LEDS; i++) {
              if (networks[i] === current && !orderedNetwork.includes(i)) {
                current = i;
                found = true;
                break;
              }
            }
            if (!found) break;
          }
          
          orderedNetwork = [current];
          while (networks[current] !== orderedNetwork[0]) {
            current = networks[current];
            orderedNetwork.push(current);
          }
          
          const index = orderedNetwork.indexOf(pos);
          
          let chain = [];
          for (let i = 0; i < orderedNetwork.length; i++) {
            chain.push((i + 1).toString());
          }
          
          return `–°–µ—Ç—å –Ω–æ—Ä: [${orderedNetwork.join(', ')}]<br>–°–≤—è–∑–∫–∞: ${chain.join('-')}<br>–¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –≤ —Å–µ—Ç–∏: ${index + 1}`;
        }
      }
      return null;
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–≤–µ—Ç–æ–¥–∏–æ–¥–µ
    function showLedInfo(pos) {
      infoPanel.style.display = 'block';
      
      let html = '';
      html += `<div><strong>–ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä:</strong> ${pos}</div>`;
      
      let rowIndex = -1;
      let positionInRow = -1;
      let isReversed = false;
      
      for (let i = 0; i < ROWS.length; i++) {
        const row = ROWS[i];
        if (pos >= row.start && pos < row.start + row.count) {
          rowIndex = i;
          positionInRow = pos - row.start;
          isReversed = i % 2 === 1;
          break;
        }
      }
      
      if (rowIndex !== -1) {
        html += `<div><strong>–°—Ç—Ä–æ–∫–∞:</strong> ${rowIndex + 1} (${isReversed ? '—Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ' : '—Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ'})</div>`;
        html += `<div><strong>–ü–æ–∑–∏—Ü–∏—è –≤ —Å—Ç—Ä–æ–∫–µ:</strong> ${positionInRow + 1}</div>`;
      }
      
      if (pos === 0) {
        html += `<div><strong>–¢–∏–ø:</strong> –°—Ç–∞—Ä—Ç (–Ω–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –º—ã—à–∏)</div>`;
      } else if (pos === finishPos) {
        html += `<div><strong>–¢–∏–ø:</strong> –§–∏–Ω–∏—à (—Ü–µ–ª—å –º—ã—à–∏)</div>`;
      } else if (networks[pos] === ELEMENT_TYPES.BAG) {
        html += `<div><strong>–¢–∏–ø:</strong> –ú–µ—à–æ–∫</div>`;
      } else if (networks[pos] === ELEMENT_TYPES.PATH) {
        html += `<div><strong>–¢–∏–ø:</strong> –¢—Ä–æ–ø–∏–Ω–∫–∞ (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å—Å—è)</div>`;
      } else if (networks[pos] < 180) {
        html += `<div><strong>–¢–∏–ø:</strong> –ù–æ—Ä–∞ (—Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –º—ã—à—å)</div>`;
        
        const holeInfo = updateHoleInfo(pos);
        if (holeInfo) {
          html += `<div style="margin: 10px 0; padding: 10px; background: #222; border-radius: 6px;">`;
          html += holeInfo;
          html += `</div>`;
        }
        
        let foundNetwork = null;
        let holeIndex = -1;
        
        for (let n = 0; n < holeNetworks.length; n++) {
          const network = holeNetworks[n];
          const index = network.indexOf(pos);
          if (index !== -1) {
            foundNetwork = n;
            holeIndex = index;
            break;
          }
        }
        
        if (foundNetwork === null && currentMode === 'hole') {
          const index = holeNetwork.indexOf(pos);
          if (index !== -1) {
            foundNetwork = holeNetworks.length;
            holeIndex = index;
          }
        }
        
        if (foundNetwork !== null) {
          const color = getNetworkColor(foundNetwork);
          html += `<div><strong>–°–µ—Ç—å –Ω–æ—Ä:</strong> ‚Ññ${foundNetwork + 1}</div>`;
          html += `<div><strong>–ù–æ–º–µ—Ä –≤ —Å–µ—Ç–∏:</strong> ${holeIndex + 1}</div>`;
          html += `<div><strong>–¶–≤–µ—Ç —Å–µ—Ç–∏:</strong> <span style="color:${color}">${color}</span></div>`;
          
          if (foundNetwork < holeNetworks.length) {
            const network = holeNetworks[foundNetwork];
            const nextIndex = (holeIndex + 1) % network.length;
            const nextPos = network[nextIndex];
            html += `<div><strong>–°–≤—è–∑–∞–Ω–∞ —Å:</strong> –∫–ª–µ—Ç–∫–∞ ‚Ññ${nextPos}</div>`;
          }
        }
      } else {
        html += `<div><strong>–¢–∏–ø:</strong> –ü—É—Å—Ç–æ (–æ–±—ã—á–Ω–∞—è –∫–ª–µ—Ç–∫–∞, –ø–æ –Ω–µ–π –Ω–µ–ª—å–∑—è —Ö–æ–¥–∏—Ç—å)</div>`;
      }
      
      html += `<div><strong>–ó–Ω–∞—á–µ–Ω–∏–µ –≤ –º–∞—Å—Å–∏–≤–µ:</strong> networks[${pos}] = ${networks[pos]}</div>`;
      
      infoDetails.innerHTML = html;
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ —É—Ä–æ–≤–Ω—è
    function generateLevelCode() {
      const levelNum = document.getElementById('levelNum').value;
      const levelName = document.getElementById('levelName').value;
      
      if (!levelNum) {
        return '// –û—à–∏–±–∫–∞: –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —É—Ä–æ–≤–Ω—è';
      }

      let code = `else if (level == ${levelNum}) {  // ${levelName}\n`;
      code += `    L_FINISH = ${finishPos};\n`;
      code += `    networks[0] = 181;\n`;
      code += `    networks[${finishPos}] = 182;\n`;
      code += `    currPos = 0;\n\n`;

      if (holeNetworks.length > 0) {
        code += `    // –°–µ—Ç–∏ –Ω–æ—Ä\n`;
        
        holeNetworks.forEach((network, networkIndex) => {
          code += `    // –°–µ—Ç—å –Ω–æ—Ä ${networkIndex + 1}\n`;
          for (let i = 0; i < network.length; i++) {
            const current = network[i];
            const next = network[(i + 1) % network.length];
            code += `    networks[${current}] = ${next};\n`;
          }
          code += `\n`;
        });
      }

      const bags = [];
      for (let i = 1; i < NUM_LEDS; i++) {
        if (networks[i] === ELEMENT_TYPES.BAG) {
          bags.push(i);
        }
      }
      
      if (bags.length > 0) {
        code += `    // –ú–µ—à–∫–∏\n`;
        bags.forEach(bag => {
          code += `    networks[${bag}] = 183;\n`;
        });
        code += `\n`;
      }

      const paths = [];
      let currentPath = [];
      
      for (let i = 1; i < NUM_LEDS; i++) {
        if (networks[i] === ELEMENT_TYPES.PATH) {
          if (currentPath.length === 0 || i === currentPath[currentPath.length - 1] + 1) {
            currentPath.push(i);
          } else {
            paths.push([...currentPath]);
            currentPath = [i];
          }
        } else if (currentPath.length > 0) {
          paths.push([...currentPath]);
          currentPath = [];
        }
      }
      
      if (currentPath.length > 0) {
        paths.push(currentPath);
      }
      
      if (paths.length > 0) {
        code += `    // –¢—Ä–æ–ø–∏–Ω–∫–∏\n`;
        paths.forEach((path, index) => {
          const pathNum = index + 1;
          if (path.length === 1) {
            code += `    networks[${path[0]}] = 185;  // –¢—Ä–æ–ø–∏–Ω–∫–∞ ${pathNum}\n`;
          } else {
            code += `    for (int i = ${path[0]}; i <= ${path[path.length - 1]}; i++) networks[i] = 185;  // –¢—Ä–æ–ø–∏–Ω–∫–∞ ${pathNum}\n`;
          }
        });
      }

      code += `  }`;
      return code;
    }

    // =============================================
    // –≠–ú–£–õ–Ø–¢–û–† –ò–ì–†–´
    // =============================================

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —ç–º—É–ª—è—Ç–æ—Ä–∞
    let emulatorNetworks = new Array(NUM_LEDS).fill(180);
    let emulatorCurrPos = 0;
    let emulatorGameWon = false;
    let emulatorL_FINISH = 0;
    let currentEmulatorLevel = 1;
    let isEmulatorCustomLevel = false;

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã —ç–º—É–ª—è—Ç–æ—Ä–∞
    const emulatorStripEl = document.getElementById('emulatorStrip');
    const emulatorStatus = document.getElementById('emulatorStatus');
    const emulatorLevelSelect = document.getElementById('emulatorLevel');
    const customLevelSection = document.getElementById('customLevelSection');
    const emulatorCustomCode = document.getElementById('emulatorCustomCode');
    const loadEmulatorLevelBtn = document.getElementById('loadEmulatorLevel');
    const emulatorResetBtn = document.getElementById('emulatorReset');
    const emulatorSolutionBtn = document.getElementById('emulatorSolution');
    const emulatorSolutionContainer = document.getElementById('emulatorSolutionContainer');
    const emulatorSolutionSteps = document.getElementById('emulatorSolutionSteps');
    const emulatorLeftBtn = document.getElementById('emulatorLeft');
    const emulatorCenterBtn = document.getElementById('emulatorCenter');
    const emulatorRightBtn = document.getElementById('emulatorRight');

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–º—É–ª—è—Ç–æ—Ä–∞
    function initEmulator() {
      createEmulatorStrip();
      
      loadStandardLevel(1);
      
      emulatorLevelSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
          customLevelSection.style.display = 'block';
        } else {
          customLevelSection.style.display = 'none';
          loadStandardLevel(parseInt(this.value));
        }
      });
      
      loadEmulatorLevelBtn.addEventListener('click', loadCustomLevelToEmulator);
      emulatorResetBtn.addEventListener('click', resetEmulator);
      emulatorSolutionBtn.addEventListener('click', showEmulatorSolution);
      emulatorLeftBtn.addEventListener('click', moveEmulatorLeft);
      emulatorCenterBtn.addEventListener('click', moveEmulatorToHole);
      emulatorRightBtn.addEventListener('click', moveEmulatorRight);
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –ª–µ–Ω—Ç—ã —ç–º—É–ª—è—Ç–æ—Ä–∞
    function createEmulatorStrip() {
      emulatorStripEl.innerHTML = '';
      
      ROWS.forEach(row => {
        const rowEl = document.createElement('div');
        rowEl.className = 'row';
        for (let i = row.start; i < row.start + row.count; i++) {
          const led = document.createElement('div');
          led.className = 'led';
          led.id = `emulator-led-${i}`;
          rowEl.appendChild(led);
        }
        emulatorStripEl.appendChild(rowEl);
      });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–º—É–ª—è—Ç–æ—Ä–∞
    function updateEmulatorDisplay() {
      for (let i = 0; i < NUM_LEDS; i++) {
        const led = document.getElementById(`emulator-led-${i}`);
        if (!led) continue;

        let color = '#222';
        if (emulatorNetworks[i] === 180) color = '#222';
        else if (emulatorNetworks[i] === 181) color = 'blue';
        else if (emulatorNetworks[i] === 182) color = 'red';
        else if (emulatorNetworks[i] === 183) color = 'orange';
        else if (emulatorNetworks[i] === 185) color = 'yellow';
        else if (emulatorNetworks[i] < 180) color = 'green';

        led.style.backgroundColor = color;
      }

      const currLed = document.getElementById(`emulator-led-${emulatorCurrPos}`);
      if (currLed) {
        currLed.style.backgroundColor = 'white';
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è
    function loadStandardLevel(level) {
      emulatorNetworks.fill(180);
      currentEmulatorLevel = level;
      isEmulatorCustomLevel = false;
      
      if (level === 1) {
        emulatorL_FINISH = 36;
        emulatorNetworks[0] = 181;
        emulatorNetworks[35] = 182;
        emulatorCurrPos = 0;

        emulatorNetworks[1] = 12; emulatorNetworks[12] = 23; emulatorNetworks[23] = 1;
        emulatorNetworks[2] = 17; emulatorNetworks[17] = 29; emulatorNetworks[29] = 7; emulatorNetworks[7] = 2;
        emulatorNetworks[6] = 19; emulatorNetworks[19] = 32; emulatorNetworks[32] = 33; emulatorNetworks[33] = 6;
        emulatorNetworks[5] = 15; emulatorNetworks[15] = 5;
        emulatorNetworks[14] = 35; emulatorNetworks[35] = 14;
        emulatorNetworks[36] = 182;
      } else if (level === 2) {
        emulatorL_FINISH = 179;
        emulatorNetworks[0] = 181;
        emulatorNetworks[179] = 182;
        emulatorCurrPos = 0;

        emulatorNetworks[1] = 46; emulatorNetworks[46] = 175; emulatorNetworks[175] = 100; emulatorNetworks[100] = 137; emulatorNetworks[137] = 1;
        emulatorNetworks[11] = 88; emulatorNetworks[88] = 148; emulatorNetworks[148] = 54; emulatorNetworks[54] = 169; emulatorNetworks[169] = 11;
        emulatorNetworks[21] = 43; emulatorNetworks[43] = 170; emulatorNetworks[170] = 95; emulatorNetworks[95] = 130; emulatorNetworks[130] = 21;
        emulatorNetworks[23] = 157; emulatorNetworks[157] = 144; emulatorNetworks[144] = 113; emulatorNetworks[113] = 75; emulatorNetworks[75] = 23;
        emulatorNetworks[35] = 80; emulatorNetworks[80] = 62; emulatorNetworks[62] = 122; emulatorNetworks[122] = 178; emulatorNetworks[178] = 35;
        emulatorNetworks[179] = 182;

        const bags = [176,163,116,134,141,107,84,39,50,58,71,6,22,29];
        bags.forEach(i => emulatorNetworks[i] = 183);

        for (let i = 12; i <= 20; i++) emulatorNetworks[i] = 185;
        emulatorNetworks[44] = 185; emulatorNetworks[45] = 185;
        for (let i = 89; i <= 94; i++) emulatorNetworks[i] = 185;
        for (let i = 96; i <= 99; i++) emulatorNetworks[i] = 185;
        for (let i = 145; i <= 147; i++) emulatorNetworks[i] = 185;
        for (let i = 123; i <= 129; i++) emulatorNetworks[i] = 185;
        for (let i = 171; i <= 174; i++) emulatorNetworks[i] = 185;
      } else if (level === 3) {
        emulatorL_FINISH = 179;
        emulatorNetworks[0] = 181;
        emulatorNetworks[179] = 182;
        emulatorCurrPos = 0;

        emulatorNetworks[1] = 53; emulatorNetworks[53] = 169; emulatorNetworks[169] = 40; emulatorNetworks[40] = 69; emulatorNetworks[69] = 100; emulatorNetworks[100] = 102; emulatorNetworks[102] = 1;
        emulatorNetworks[8] = 9; emulatorNetworks[9] = 174; emulatorNetworks[174] = 131; emulatorNetworks[131] = 68; emulatorNetworks[68] = 70; emulatorNetworks[70] = 8;
        emulatorNetworks[10] = 131; emulatorNetworks[131] = 88; emulatorNetworks[88] = 60; emulatorNetworks[60] = 2; emulatorNetworks[2] = 80; emulatorNetworks[80] = 94; emulatorNetworks[94] = 10;
        emulatorNetworks[18] = 87; emulatorNetworks[87] = 62; emulatorNetworks[62] = 47; emulatorNetworks[47] = 78; emulatorNetworks[78] = 110; emulatorNetworks[110] = 132; emulatorNetworks[132] = 18;
        emulatorNetworks[37] = 155; emulatorNetworks[155] = 101; emulatorNetworks[101] = 118; emulatorNetworks[118] = 124; emulatorNetworks[124] = 147; emulatorNetworks[147] = 143; emulatorNetworks[143] = 37;
        emulatorNetworks[33] = 41; emulatorNetworks[41] = 136; emulatorNetworks[136] = 23; emulatorNetworks[23] = 160; emulatorNetworks[160] = 74; emulatorNetworks[74] = 79; emulatorNetworks[79] = 33;
        emulatorNetworks[144] = 178; emulatorNetworks[179] = 182;

        const bags = [5,14,27,44,55,65,72,84,97,106,115,128,141,149,164,176];
        bags.forEach(i => emulatorNetworks[i] = 183);

        for (let i = 19; i <= 22; i++) emulatorNetworks[i] = 185;
        for (let i = 34; i <= 36; i++) emulatorNetworks[i] = 185;
        for (let i = 48; i <= 52; i++) emulatorNetworks[i] = 185;
        emulatorNetworks[61] = 185;
        for (let i = 89; i <= 93; i++) emulatorNetworks[i] = 185;
        for (let i = 119; i <= 123; i++) emulatorNetworks[i] = 185;
        for (let i = 133; i <= 135; i++) emulatorNetworks[i] = 185;
        for (let i = 145; i <= 146; i++) emulatorNetworks[i] = 185;
        for (let i = 156; i <= 159; i++) emulatorNetworks[i] = 185;
        for (let i = 170; i <= 173; i++) emulatorNetworks[i] = 185;
      }
      
      emulatorGameWon = false;
      emulatorStatus.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω —É—Ä–æ–≤–µ–Ω—å ${level}`;
      updateEmulatorDisplay();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è –≤ —ç–º—É–ª—è—Ç–æ—Ä
    function loadCustomLevelToEmulator() {
      const code = emulatorCustomCode.value;
      if (!code) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —É—Ä–æ–≤–Ω—è');
        return;
      }
      
      try {
        const levelData = parseLevelCode(code);
        
        emulatorNetworks.fill(180);
        emulatorNetworks[0] = 181;
        emulatorNetworks[levelData.L_FINISH] = 182;
        emulatorL_FINISH = levelData.L_FINISH;
        emulatorCurrPos = 0;
        
        for (const [from, to] of levelData.holeConnections) {
          if (from >= 0 && from < NUM_LEDS && to >= 0 && to < NUM_LEDS) {
            emulatorNetworks[from] = to;
          }
        }
        
        levelData.bags.forEach(bag => {
          if (bag >= 0 && bag < NUM_LEDS) {
            emulatorNetworks[bag] = 183;
          }
        });
        
        levelData.paths.forEach(path => {
          for (let i = path.start; i <= path.end; i++) {
            if (i >= 0 && i < NUM_LEDS) {
              emulatorNetworks[i] = 185;
            }
          }
        });
        
        isEmulatorCustomLevel = true;
        emulatorGameWon = false;
        emulatorStatus.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∑–∞–≥—Ä—É–∂–µ–Ω';
        updateEmulatorDisplay();
        showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —ç–º—É–ª—è—Ç–æ—Ä');
      } catch (error) {
        emulatorStatus.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–≤–Ω—è';
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –∫–æ–¥–∞ —É—Ä–æ–≤–Ω—è');
      }
    }

    // –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–¥–∞ —É—Ä–æ–≤–Ω—è
    function parseLevelCode(code) {
      const result = {
        levelNumber: null,
        L_FINISH: 179,
        holeConnections: new Map(),
        bags: [],
        paths: []
      };

      const levelMatch = code.match(/else\s+if\s+\(level\s*==\s*(\d+)\)/);
      if (levelMatch) {
        result.levelNumber = parseInt(levelMatch[1]);
      }

      const finishMatch = code.match(/L_FINISH\s*=\s*(\d+);/);
      if (finishMatch) {
        result.L_FINISH = parseInt(finishMatch[1]);
      }

      const holeMatches = code.matchAll(/networks\[(\d+)\]\s*=\s*(\d+)\s*;/g);
      for (const match of holeMatches) {
        const from = parseInt(match[1]);
        const to = parseInt(match[2]);
        
        if (from !== 0 && to !== 0 && from !== result.L_FINISH && to !== result.L_FINISH) {
          result.holeConnections.set(from, to);
        }
      }

      const bagMatches = code.matchAll(/networks\[(\d+)\]\s*=\s*183\s*;/g);
      for (const match of bagMatches) {
        const pos = parseInt(match[1]);
        result.bags.push(pos);
      }

      const pathRangeMatches = code.matchAll(/for\s*\(int\s*i\s*=\s*(\d+)\s*;\s*i\s*<=\s*(\d+)\s*;\s*i\+\+\)\s*networks\[i\]\s*=\s*185\s*;/g);
      for (const match of pathRangeMatches) {
        const start = parseInt(match[1]);
        const end = parseInt(match[2]);
        result.paths.push({ start, end });
      }

      const pathSingleMatches = code.matchAll(/networks\[(\d+)\]\s*=\s*185\s*;/g);
      for (const match of pathSingleMatches) {
        const pos = parseInt(match[1]);
        result.paths.push({ start: pos, end: pos });
      }

      return result;
    }

    // –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞ –ø—É—Ç–∏
    function findSolution(start, target, networksArray) {
      const queue = [{pos: start, path: [], visited: new Set([start])}];
      const maxIterations = 20000;
      let iterations = 0;
      
      while (queue.length > 0 && iterations < maxIterations) {
        iterations++;
        const {pos, path, visited} = queue.shift();
        
        if (pos === target) {
          return path;
        }
        
        const moves = [];
        
        const rowLen = (pos < 152) ? 38 : 28;
        const rowStart = pos - (pos % rowLen);
        
        const leftPos = pos - 1;
        if (leftPos >= rowStart) {
          const leftVal = networksArray[leftPos];
          if (leftVal === 185 || leftVal < 180 || leftVal === 182) {
            moves.push({
              pos: leftPos,
              action: '–í–ª–µ–≤–æ',
              visited: new Set([...visited, leftPos])
            });
          }
        }
        
        const rightPos = pos + 1;
        const rowEnd = rowStart + rowLen;
        if (rightPos < rowEnd) {
          const rightVal = networksArray[rightPos];
          if (rightVal === 185 || rightVal < 180 || rightVal === 182) {
            moves.push({
              pos: rightPos,
              action: '–í–ø—Ä–∞–≤–æ',
              visited: new Set([...visited, rightPos])
            });
          }
        }
        
        if (networksArray[pos] < 180) {
          const holePos = networksArray[pos];
          moves.push({
            pos: holePos,
            action: '–ó–∞–Ω—ã—Ä–Ω—É—Ç—å',
            visited: new Set([...visited, holePos])
          });
        }
        
        for (const move of moves) {
          if (!visited.has(move.pos)) {
            queue.push({
              pos: move.pos,
              path: [...path, move.action],
              visited: move.visited
            });
          }
        }
      }
      
      return null;
    }

    // –î–≤–∏–∂–µ–Ω–∏–µ –≤–ª–µ–≤–æ –≤ —ç–º—É–ª—è—Ç–æ—Ä–µ
    function moveEmulatorLeft() {
      if (emulatorGameWon) return;
      
      const rowLen = (emulatorCurrPos < 152) ? 38 : 28;
      const start = emulatorCurrPos - (emulatorCurrPos % rowLen);
      const nextPos = emulatorCurrPos - 1;
      
      if (nextPos < start) return;
      
      const nextValue = emulatorNetworks[nextPos];
      if (nextValue === 185 || nextValue < 180 || nextValue === 182) {
        emulatorCurrPos = nextPos;
      }
      
      checkEmulatorWin();
      updateEmulatorDisplay();
    }

    // –î–≤–∏–∂–µ–Ω–∏–µ –≤–ø—Ä–∞–≤–æ –≤ —ç–º—É–ª—è—Ç–æ—Ä–µ
    function moveEmulatorRight() {
      if (emulatorGameWon) return;
      
      const rowLen = (emulatorCurrPos < 152) ? 38 : 28;
      const start = emulatorCurrPos - (emulatorCurrPos % rowLen);
      const end = start + rowLen;
      const nextPos = emulatorCurrPos + 1;
      
      if (nextPos >= end) return;
      
      const nextValue = emulatorNetworks[nextPos];
      if (nextValue === 185 || nextValue < 180 || nextValue === 182) {
        emulatorCurrPos = nextPos;
      }
      
      checkEmulatorWin();
      updateEmulatorDisplay();
    }

    // –ü–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑ –Ω–æ—Ä—É –≤ —ç–º—É–ª—è—Ç–æ—Ä–µ
    function moveEmulatorToHole() {
      if (emulatorGameWon) return;
      
      if (emulatorNetworks[emulatorCurrPos] >= 0 && 
          emulatorNetworks[emulatorCurrPos] < 180) {
        emulatorCurrPos = emulatorNetworks[emulatorCurrPos];
      }
      
      checkEmulatorWin();
      updateEmulatorDisplay();
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã –≤ —ç–º—É–ª—è—Ç–æ—Ä–µ
    function checkEmulatorWin() {
      if (emulatorCurrPos === emulatorL_FINISH) {
        emulatorGameWon = true;
        emulatorStatus.textContent = "üéâ –ü–û–ë–ï–î–ê! –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!";
        showNotification("üéâ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω! –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!");
      }
    }

    // –°–±—Ä–æ—Å —ç–º—É–ª—è—Ç–æ—Ä–∞
    function resetEmulator() {
      emulatorCurrPos = 0;
      emulatorGameWon = false;
      
      if (isEmulatorCustomLevel) {
        emulatorStatus.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–±—Ä–æ—à–µ–Ω";
      } else {
        emulatorStatus.textContent = `–£—Ä–æ–≤–µ–Ω—å ${currentEmulatorLevel} —Å–±—Ä–æ—à–µ–Ω`;
      }
      
      updateEmulatorDisplay();
    }

    // –ü–æ–∏—Å–∫ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —ç–º—É–ª—è—Ç–æ—Ä–∞
    function findEmulatorSolution() {
      return findSolution(0, emulatorL_FINISH, emulatorNetworks);
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ –≤ —ç–º—É–ª—è—Ç–æ—Ä–µ
    function showEmulatorSolution() {
      const solution = findEmulatorSolution();
      
      if (!solution || solution.length === 0) {
        showNotification('–†–µ—à–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –£—Ä–æ–≤–µ–Ω—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–æ—Ö–æ–¥–∏–º—ã–º.');
        document.getElementById('emulatorSpoiler').classList.add('open');
        emulatorSolutionSteps.innerHTML = '<div style="color: #ff5555; text-align: center; padding: 20px;">–†–µ—à–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –£—Ä–æ–≤–µ–Ω—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–æ—Ö–æ–¥–∏–º—ã–º –∏–ª–∏ –∞–ª–≥–æ—Ä–∏—Ç–º –Ω–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ –ø—É—Ç—å.</div>';
        return;
      }
      
      emulatorSolutionSteps.innerHTML = '';
      
      solution.forEach((step, index) => {
        const stepEl = document.createElement('div');
        stepEl.className = 'solution-step';
        stepEl.innerHTML = `<span class="step-number">${index + 1}</span> ${step}`;
        emulatorSolutionSteps.appendChild(stepEl);
      });
      
      const finalStep = document.createElement('div');
      finalStep.className = 'solution-step';
      finalStep.innerHTML = `<span class="step-number">${solution.length + 1}</span> üéâ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!`;
      emulatorSolutionSteps.appendChild(finalStep);
      
      document.getElementById('emulatorSpoiler').classList.add('open');
      
      document.getElementById('emulatorSpoiler').scrollIntoView({ behavior: 'smooth' });
    }

    // =============================================
    // –ì–ï–ù–ï–†–ê–¢–û–† –£–†–û–í–ù–ï–ô
    // =============================================

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
    const generatorStripEl = document.getElementById('generatorStrip');
    const generatorLevelNum = document.getElementById('generatorLevelNum');
    const generatorLevelName = document.getElementById('generatorLevelName');
    const generatorStatus = document.getElementById('generatorStatus');
    const generateBtn = document.getElementById('generateBtn');
    const generatorCopyBtn = document.getElementById('generatorCopyBtn');
    const generatorLoadBtn = document.getElementById('generatorLoadBtn');
    const generatorLoadEmulatorBtn = document.getElementById('generatorLoadEmulatorBtn');
    const generatorExportToDeviceBtn = document.getElementById('generatorExportToDeviceBtn');
    const generatorCodeOutput = document.getElementById('generatorCodeOutput');
    const generatorSolutionSteps = document.getElementById('generatorSolutionSteps');

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
    let generatedLevelData = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
    function initGenerator() {
      createGeneratorStrip();
      
      generateBtn.addEventListener('click', generateLevel);
      generatorCopyBtn.addEventListener('click', copyGeneratedCode);
      generatorLoadBtn.addEventListener('click', loadGeneratedToEditor);
      generatorLoadEmulatorBtn.addEventListener('click', loadGeneratedToEmulator);
      generatorExportToDeviceBtn.addEventListener('click', exportGeneratedToDevice);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–∑—É–Ω–∫–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
    function initGeneratorSliders() {
      const sliders = [
        { id: 'pathCountSlider', valueId: 'pathCountValue' },
        { id: 'bagCountSlider', valueId: 'bagCountValue' },
        { id: 'holePerNetworkSlider', valueId: 'holePerNetworkValue' },
        { id: 'networkCountSlider', valueId: 'networkCountValue' }
      ];
      
      sliders.forEach(({id, valueId}) => {
        const slider = document.getElementById(id);
        const value = document.getElementById(valueId);
        
        if (slider && value) {
          slider.addEventListener('input', function() {
            value.textContent = this.value;
          });
          
          value.textContent = slider.value;
        }
      });
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –ª–µ–Ω—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
    function createGeneratorStrip() {
      generatorStripEl.innerHTML = '';
      
      ROWS.forEach(row => {
        const rowEl = document.createElement('div');
        rowEl.className = 'row';
        for (let i = row.start; i < row.start + row.count; i++) {
          const led = document.createElement('div');
          led.className = 'led';
          led.id = `generator-led-${i}`;
          rowEl.appendChild(led);
        }
        generatorStripEl.appendChild(rowEl);
      });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
    function updateGeneratorDisplay() {
      if (!generatedLevelData) return;
      
      for (let i = 0; i < NUM_LEDS; i++) {
        const led = document.getElementById(`generator-led-${i}`);
        if (!led) continue;

        let color = '#222';
        if (generatedLevelData.networks[i] === 180) color = '#222';
        else if (generatedLevelData.networks[i] === 181) color = 'blue';
        else if (generatedLevelData.networks[i] === 182) color = 'red';
        else if (generatedLevelData.networks[i] === 183) color = 'orange';
        else if (generatedLevelData.networks[i] === 185) color = 'yellow';
        else if (generatedLevelData.networks[i] < 180) color = 'green';

        led.style.backgroundColor = color;
      }
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è
    function generateLevel() {
      const levelNum = generatorLevelNum.value;
      const levelName = generatorLevelName.value;
      
      if (!levelNum) {
        generatorStatus.textContent = '–û—à–∏–±–∫–∞: –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —É—Ä–æ–≤–Ω—è';
        return;
      }
      
      generatorStatus.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è...';
      
      setTimeout(() => {
        try {
          const level = generateGuaranteedPassableLevel(levelNum, levelName);
          
          generatedLevelData = level;
          
          generatorCodeOutput.textContent = level.code;
          displayGeneratorSolution(level.solution);
          updateGeneratorDisplay();
          
          generatorStatus.textContent = `–£—Ä–æ–≤–µ–Ω—å ${levelNum} —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!`;
          showNotification('–£—Ä–æ–≤–µ–Ω—å —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω');
        } catch (error) {
          generatorStatus.textContent = `–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${error.message}`;
        }
      }, 500);
    }
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏–º–æ–≥–æ —É—Ä–æ–≤–Ω—è
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏–º–æ–≥–æ —É—Ä–æ–≤–Ω—è (–Ω–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º)
function generateGuaranteedPassableLevel(levelNum, levelName) {
  console.log("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è —Å –Ω–æ–≤—ã–º –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º...");
  
  const params = {
    numPaths: parseInt(document.getElementById('pathCountSlider').value),
    numBags: parseInt(document.getElementById('bagCountSlider').value),
    holesPerNetwork: parseInt(document.getElementById('holePerNetworkSlider').value),
    numNetworks: parseInt(document.getElementById('networkCountSlider').value)
  };
  
  console.log("–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:", params);
  
  // –£–≤–µ–ª–∏—á–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
  let attempts = 0;
  const maxAttempts = 50;
  
  while (attempts < maxAttempts) {
    attempts++;
    console.log(`–ü–æ–ø—ã—Ç–∫–∞ ${attempts}...`);
    
    try {
      const networks = new Array(NUM_LEDS).fill(ELEMENT_TYPES.EMPTY);
      const usedPositions = new Set([0, 179]); // –°—Ç–∞—Ä—Ç –∏ —Ñ–∏–Ω–∏—à —É–∂–µ –∑–∞–Ω—è—Ç—ã
      const holeNetworks = [];
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—Ç –∏ —Ñ–∏–Ω–∏—à
      networks[0] = ELEMENT_TYPES.START;
      networks[179] = ELEMENT_TYPES.FINISH;
      
      // 1. –°–û–ó–î–ê–ï–ú –ü–†–û–°–¢–û–ô –ü–£–¢–¨ –û–¢ –°–¢–ê–†–¢–ê –ö –§–ò–ù–ò–®–£
      console.log("–°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å...");
      const mainPath = createSimplePath(0, 179, networks, usedPositions);
      
      if (!mainPath) {
        console.log("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞...");
        continue;
      }
      
      // 2. –°–û–ó–î–ê–ï–ú –°–ï–¢–ò –ù–û–† –ù–ê –†–ê–ó–ù–´–• –°–¢–†–û–ö–ê–•
      console.log("–°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∏ –Ω–æ—Ä...");
      for (let n = 0; n < params.numNetworks; n++) {
        const network = createHoleNetwork(params.holesPerNetwork, networks, usedPositions, mainPath);
        if (network && network.length >= 2) {
          holeNetworks.push(network);
          
          // –°–æ–∑–¥–∞–µ–º —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å–≤—è–∑–∏ –≤ —Å–µ—Ç–∏
          for (let i = 0; i < network.length; i++) {
            const current = network[i];
            const next = network[(i + 1) % network.length];
            networks[current] = next;
          }
        }
      }
      
      // 3. –î–û–ë–ê–í–õ–Ø–ï–ú –ú–ï–®–ö–ò (–ù–ï –ù–ê –ü–£–¢–ò –ò –ù–ï –í –ù–û–†–ê–•)
      console.log("–î–æ–±–∞–≤–ª—è–µ–º –º–µ—à–∫–∏...");
      for (let i = 0; i < params.numBags; i++) {
        let bagPos;
        let attemptsBag = 0;
        do {
          bagPos = Math.floor(Math.random() * NUM_LEDS);
          attemptsBag++;
        } while ((usedPositions.has(bagPos) || networks[bagPos] < 180) && attemptsBag < 100);
        
        if (bagPos && !usedPositions.has(bagPos)) {
          networks[bagPos] = ELEMENT_TYPES.BAG;
          usedPositions.add(bagPos);
        }
      }
      
      // 4. –î–û–ë–ê–í–õ–Ø–ï–ú –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –¢–†–û–ü–ò–ù–ö–ò
      console.log("–î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–æ–ø–∏–Ω–∫–∏...");
      for (let p = 0; p < params.numPaths; p++) {
        addRandomPath(networks, usedPositions);
      }
      
      // 5. –ü–†–û–í–ï–†–Ø–ï–ú –ü–†–û–•–û–î–ò–ú–û–°–¢–¨
      console.log("–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å...");
      const solution = findSolutionWithRules(0, 179, networks);
      
      if (solution && solution.length > 0) {
        console.log("–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Ö–æ–¥–∏–º! –†–µ—à–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ.");
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥
        const code = generateLevelCodeFromNetworks(levelNum, levelName, networks, 179);
        
        return {
          networks: networks,
          code: code,
          solution: solution,
          L_FINISH: 179,
          holeNetworks: holeNetworks
        };
      } else {
        console.log("–£—Ä–æ–≤–µ–Ω—å –Ω–µ–ø—Ä–æ—Ö–æ–¥–∏–º, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞...");
      }
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:", error);
    }
  }
  
  throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ö–æ–¥–∏–º—ã–π —É—Ä–æ–≤–µ–Ω—å –ø–æ—Å–ª–µ ${maxAttempts} –ø–æ–ø—ã—Ç–æ–∫`);
}

// –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –ø—É—Ç–∏ –æ—Ç start –¥–æ finish
function createSimplePath(start, finish, networks, usedPositions) {
  const path = [start];
  let current = start;
  
  while (current !== finish) {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
    const row = getRow(current);
    const rowStart = ROWS[row].start;
    const rowEnd = rowStart + ROWS[row].count - 1;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫ —Ñ–∏–Ω–∏—à—É
    const targetDirection = finish > current ? 1 : -1;
    
    // –ü—Ä–æ–±—É–µ–º –¥–≤–∏–≥–∞—Ç—å—Å—è –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ñ–∏–Ω–∏—à–∞
    let nextPos = current + targetDirection;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ –≤—ã—à–ª–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Å—Ç—Ä–æ–∫–∏
    if (nextPos < rowStart || nextPos > rowEnd) {
      // –ù—É–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–æ–∫—É
      if (row < 4 && targetDirection > 0) {
        // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É
        nextPos = ROWS[row + 1].start;
      } else if (row > 0 && targetDirection < 0) {
        // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–æ–∫—É
        nextPos = ROWS[row - 1].start + (ROWS[row - 1].count - 1);
      } else {
        // –ù–µ –º–æ–∂–µ–º –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ
        return null;
      }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–µ—Ç–∫–∞ —Å–≤–æ–±–æ–¥–Ω–∞
    if (usedPositions.has(nextPos)) {
      // –ö–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞, –ø—Ä–æ–±—É–µ–º –æ–±–æ–π—Ç–∏
      let alternativePos;
      if (Math.random() > 0.5) {
        alternativePos = current + 1;
        if (alternativePos > rowEnd) alternativePos = current - 1;
      } else {
        alternativePos = current - 1;
        if (alternativePos < rowStart) alternativePos = current + 1;
      }
      
      if (alternativePos >= rowStart && alternativePos <= rowEnd && !usedPositions.has(alternativePos)) {
        nextPos = alternativePos;
      } else {
        return null;
      }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–µ—Ç–∫—É –≤ –ø—É—Ç—å
    path.push(nextPos);
    networks[nextPos] = ELEMENT_TYPES.PATH;
    usedPositions.add(nextPos);
    current = nextPos;
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
    if (path.length > 100) return null;
  }
  
  return path;
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–∏ –Ω–æ—Ä
function createHoleNetwork(size, networks, usedPositions, mainPath) {
  const network = [];
  
  // –ü–µ—Ä–≤–∞—è –Ω–æ—Ä–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—É—Ç–∏ (–Ω–æ –Ω–µ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ/—Ñ–∏–Ω–∏—à–µ)
  const availablePathPositions = mainPath.filter(pos => 
    pos !== 0 && pos !== 179 && 
    !usedPositions.has(pos) && 
    networks[pos] === ELEMENT_TYPES.PATH
  );
  
  if (availablePathPositions.length === 0) return null;
  
  const firstHole = availablePathPositions[Math.floor(Math.random() * availablePathPositions.length)];
  network.push(firstHole);
  usedPositions.add(firstHole);
  
  // –û—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–æ—Ä—ã –≤ —Å–ª—É—á–∞–π–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö (–Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö)
  for (let i = 1; i < size; i++) {
    let holePos;
    let attempts = 0;
    
    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è –Ω–æ—Ä—ã
    const targetRow = Math.floor(Math.random() * 5);
    const rowStart = ROWS[targetRow].start;
    const rowEnd = rowStart + ROWS[targetRow].count - 1;
    
    do {
      holePos = rowStart + Math.floor(Math.random() * (rowEnd - rowStart + 1));
      attempts++;
    } while ((usedPositions.has(holePos) || holePos === 0 || holePos === 179) && attempts < 50);
    
    if (holePos && !usedPositions.has(holePos)) {
      network.push(holePos);
      usedPositions.add(holePos);
    }
  }
  
  return network.length >= 2 ? network : null;
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–π —Ç—Ä–æ–ø–∏–Ω–∫–∏
function addRandomPath(networks, usedPositions) {
  // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–æ–∫—É
  const row = Math.floor(Math.random() * 5);
  const rowStart = ROWS[row].start;
  const rowCount = ROWS[row].count;
  
  // –î–ª–∏–Ω–∞ —Ç—Ä–æ–ø–∏–Ω–∫–∏ 1-3 –∫–ª–µ—Ç–∫–∏
  const length = 1 + Math.floor(Math.random() * 3);
  
  // –ù–∞—Ö–æ–¥–∏–º –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –º–µ—Å—Ç–æ –¥–ª—è —Ç—Ä–æ–ø–∏–Ω–∫–∏
  for (let attempt = 0; attempt < 20; attempt++) {
    const startInRow = Math.floor(Math.random() * (rowCount - length));
    const startPos = rowStart + startInRow;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∫–ª–µ—Ç–∫–∏ —Å–≤–æ–±–æ–¥–Ω—ã
    let canPlace = true;
    for (let i = 0; i < length; i++) {
      const pos = startPos + i;
      if (usedPositions.has(pos) || networks[pos] < 180) {
        canPlace = false;
        break;
      }
    }
    
    if (canPlace) {
      // –†–∞–∑–º–µ—â–∞–µ–º —Ç—Ä–æ–ø–∏–Ω–∫—É
      for (let i = 0; i < length; i++) {
        const pos = startPos + i;
        networks[pos] = ELEMENT_TYPES.PATH;
        usedPositions.add(pos);
      }
      return true;
    }
  }
  
  return false;
}

// –ü–æ–∏—Å–∫ —Ä–µ—à–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –ø—Ä–∞–≤–∏–ª –∏–≥—Ä—ã
function findSolutionWithRules(start, target, networksArray) {
  const queue = [{pos: start, path: [], visited: new Set([start]), steps: 0}];
  const maxSteps = 100; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤
  
  while (queue.length > 0) {
    const {pos, path, visited, steps} = queue.shift();
    
    if (steps > maxSteps) continue;
    
    // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ —Ñ–∏–Ω–∏—à–∞
    if (pos === target) {
      return path;
    }
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ö–æ–¥—ã
    const moves = [];
    
    // 1. –î–≤–∏–∂–µ–Ω–∏–µ –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ –ø–æ —Ç—Ä–æ–ø–∏–Ω–∫–∞–º –∏–ª–∏ –Ω–æ—Ä–∞–º
    const rowLen = (pos < 152) ? 38 : 28;
    const rowStart = pos - (pos % rowLen);
    const rowEnd = rowStart + rowLen - 1;
    
    // –í–ª–µ–≤–æ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç—Ä–æ–ø–∏–Ω–∫–∞ –∏–ª–∏ –Ω–æ—Ä–∞ —Å–ª–µ–≤–∞)
    const leftPos = pos - 1;
    if (leftPos >= rowStart) {
      const leftVal = networksArray[leftPos];
      if (leftVal === ELEMENT_TYPES.PATH || 
          (leftVal < 180 && leftVal >= 0) || 
          leftVal === ELEMENT_TYPES.FINISH) {
        moves.push({
          pos: leftPos,
          action: '–í–ª–µ–≤–æ',
          visited: new Set([...visited, leftPos]),
          steps: steps + 1
        });
      }
    }
    
    // –í–ø—Ä–∞–≤–æ
    const rightPos = pos + 1;
    if (rightPos <= rowEnd) {
      const rightVal = networksArray[rightPos];
      if (rightVal === ELEMENT_TYPES.PATH || 
          (rightVal < 180 && rightVal >= 0) || 
          rightVal === ELEMENT_TYPES.FINISH) {
        moves.push({
          pos: rightPos,
          action: '–í–ø—Ä–∞–≤–æ',
          visited: new Set([...visited, rightPos]),
          steps: steps + 1
        });
      }
    }
    
    // 2. –ó–∞–Ω—ã—Ä–Ω—É—Ç—å –≤ –Ω–æ—Ä—É (–µ—Å–ª–∏ —Å—Ç–æ–∏–º –Ω–∞ –Ω–æ—Ä–µ)
    if (networksArray[pos] < 180 && networksArray[pos] >= 0) {
      const holePos = networksArray[pos];
      moves.push({
        pos: holePos,
        action: '–ó–∞–Ω—ã—Ä–Ω—É—Ç—å',
        visited: new Set([...visited, holePos]),
        steps: steps + 1
      });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ö–æ–¥—ã –≤ –æ—á–µ—Ä–µ–¥—å (–µ—Å–ª–∏ –Ω–µ –ø–æ—Å–µ—â–∞–ª–∏ —ç—Ç—É –ø–æ–∑–∏—Ü–∏—é –≤ —Ç–µ–∫—É—â–µ–º –ø—É—Ç–∏)
    for (const move of moves) {
      if (!visited.has(move.pos)) {
        queue.push({
          pos: move.pos,
          path: [...path, move.action],
          visited: move.visited,
          steps: move.steps
        });
      }
    }
  }
  
  return null;
}

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –∏–∑ —Å–µ—Ç–µ–π
    function generateLevelCodeFromNetworks(levelNum, levelName, networks, finishPos) {
      let code = `else if (level == ${levelNum}) {  // ${levelName}\n`;
      code += `    L_FINISH = ${finishPos};\n`;
      code += `    networks[0] = 181;\n`;
      code += `    networks[${finishPos}] = 182;\n`;
      code += `    currPos = 0;\n\n`;
      
      const holeConnections = new Map();
      for (let i = 0; i < NUM_LEDS; i++) {
        if (networks[i] < 180 && networks[i] >= 0 && networks[i] !== i) {
          holeConnections.set(i, networks[i]);
        }
      }
      
      if (holeConnections.size > 0) {
        code += `    // –°–µ—Ç–∏ –Ω–æ—Ä\n`;
        const visited = new Set();
        let networkIndex = 1;
        
        for (let [from, to] of holeConnections) {
          if (!visited.has(from)) {
            const network = [];
            let current = from;
            
            while (!visited.has(current)) {
              visited.add(current);
              network.push(current);
              current = networks[current];
            }
            
            if (network.length > 1) {
              code += `    // –°–µ—Ç—å –Ω–æ—Ä ${networkIndex}\n`;
              for (let i = 0; i < network.length; i++) {
                const cur = network[i];
                const nxt = network[(i + 1) % network.length];
                code += `    networks[${cur}] = ${nxt};\n`;
              }
              code += `\n`;
              networkIndex++;
            }
          }
        }
      }
      
      const bags = [];
      for (let i = 1; i < NUM_LEDS; i++) {
        if (networks[i] === 183) {
          bags.push(i);
        }
      }
      
      if (bags.length > 0) {
        code += `    // –ú–µ—à–∫–∏\n`;
        bags.forEach(bag => {
          code += `    networks[${bag}] = 183;\n`;
        });
        code += `\n`;
      }
      
      const paths = [];
      let currentPath = [];
      
      for (let i = 1; i < NUM_LEDS; i++) {
        if (networks[i] === 185) {
          if (currentPath.length === 0 || i === currentPath[currentPath.length - 1] + 1) {
            currentPath.push(i);
          } else {
            paths.push([...currentPath]);
            currentPath = [i];
          }
        } else if (currentPath.length > 0) {
          paths.push([...currentPath]);
          currentPath = [];
        }
      }
      
      if (currentPath.length > 0) {
        paths.push(currentPath);
      }
      
      if (paths.length > 0) {
        code += `    // –¢—Ä–æ–ø–∏–Ω–∫–∏\n`;
        paths.forEach((path, index) => {
          const pathNum = index + 1;
          if (path.length === 1) {
            code += `    networks[${path[0]}] = 185;  // –¢—Ä–æ–ø–∏–Ω–∫–∞ ${pathNum}\n`;
          } else {
            code += `    for (int i = ${path[0]}; i <= ${path[path.length - 1]}; i++) networks[i] = 185;  // –¢—Ä–æ–ø–∏–Ω–∫–∞ ${pathNum}\n`;
          }
        });
      }
      
      code += `  }`;
      return code;
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
function displayGeneratorSolution(solution) {
  generatorSolutionSteps.innerHTML = '';
  
  if (!solution || solution.length === 0) {
    generatorSolutionSteps.innerHTML = '<div style="color: #ff5555; text-align: center; padding: 20px;">–†–µ—à–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –í–æ–∑–º–æ–∂–Ω–æ, —É—Ä–æ–≤–µ–Ω—å —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–π –¥–ª—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞.</div>';
    return;
  }
  
  solution.forEach((step, index) => {
    const stepEl = document.createElement('div');
    stepEl.className = 'solution-step';
    stepEl.innerHTML = `<span class="step-number">${index + 1}</span> ${step}`;
    generatorSolutionSteps.appendChild(stepEl);
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  const finalStep = document.createElement('div');
  finalStep.className = 'solution-step';
  finalStep.innerHTML = `<span class="step-number">${solution.length + 1}</span> üéâ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!`;
  generatorSolutionSteps.appendChild(finalStep);
}

    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
    function copyGeneratedCode() {
      const text = generatorCodeOutput.textContent;
      if (!text || text.includes('// –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥')) {
        showNotification('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å');
        return;
      }
      
      navigator.clipboard.writeText(text).then(() => {
        const originalText = generatorCopyBtn.textContent;
        generatorCopyBtn.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        setTimeout(() => {
          generatorCopyBtn.textContent = originalText;
        }, 2000);
        showNotification('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
      });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
    function loadGeneratedToEditor() {
      if (!generatedLevelData) {
        showNotification('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å');
        return;
      }
      
      document.querySelector('[data-tab="editor"]').click();
      
      networks = [...generatedLevelData.networks];
      finishPos = generatedLevelData.L_FINISH;
      
      holeNetworks = [];
      const visited = new Set();
      for (let i = 0; i < NUM_LEDS; i++) {
        if (networks[i] < 180 && !visited.has(i)) {
          const network = [];
          let current = i;
          
          while (!visited.has(current)) {
            visited.add(current);
            network.push(current);
            current = networks[current];
          }
          
          if (network.length > 1) {
            holeNetworks.push(network);
          }
        }
      }
      
      holeNetwork = [];
      currentMode = 'free';
      currentQuickTool = null;
      smallTools.forEach(t => t.classList.remove('active'));
      
      showAllIndices = false;
      showHoleIndices = false;
      showAllIndicesCheckbox.checked = false;
      showHoleIndicesCheckbox.checked = false;
      
      document.getElementById('levelNum').value = generatorLevelNum.value;
      document.getElementById('levelName').value = generatorLevelName.value;
      codeOutput.textContent = generatedLevelData.code;
      
      infoPanel.style.display = 'none';
      infoDetails.innerHTML = '';
      
      updateToolButtons();
      updateVisuals();
      
      showNotification('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –≤ —ç–º—É–ª—è—Ç–æ—Ä
    function loadGeneratedToEmulator() {
      if (!generatedLevelData) {
        showNotification('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å');
        return;
      }
      
      document.querySelector('[data-tab="emulator"]').click();
      
      emulatorNetworks = [...generatedLevelData.networks];
      emulatorL_FINISH = generatedLevelData.L_FINISH;
      emulatorCurrPos = 0;
      emulatorGameWon = false;
      isEmulatorCustomLevel = true;
      
      emulatorLevelSelect.value = 'custom';
      customLevelSection.style.display = 'block';
      
      emulatorCustomCode.value = generatedLevelData.code;
      
      updateEmulatorDisplay();
      emulatorStatus.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —ç–º—É–ª—è—Ç–æ—Ä';
      showNotification('–£—Ä–æ–≤–µ–Ω—å –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —ç–º—É–ª—è—Ç–æ—Ä');
    }

    // –≠–∫—Å–ø–æ—Ä—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –≤ –º–µ–Ω–µ–¥–∂–µ—Ä
    function exportGeneratedToDevice() {
      if (!generatedLevelData) {
        showNotification('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å');
        return;
      }
      
      const levelName = generatorLevelName.value;
      const levelNum = generatorLevelNum.value;
      
      addLevelToManager(generatedLevelData.code, levelName, {
        networks: [...generatedLevelData.networks],
        finishPos: generatedLevelData.L_FINISH,
        holeNetworks: generatedLevelData.holeNetworks || []
      });
      
      document.querySelector('[data-tab="device"]').click();
    }

    // =============================================
    // –ú–ï–ù–ï–î–ñ–ï–† –£–†–û–í–ù–ï–ô (–£–°–¢–†–û–ô–°–¢–í–û)
    // =============================================

    // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π –≤ –º–µ–Ω–µ–¥–∂–µ—Ä–µ
    let managedLevels = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    function initDeviceManager() {
      loadManagedLevels();
      
      document.getElementById('importLevelsBtn').addEventListener('click', importLevelsFile);
      document.getElementById('exportLevelsBtn').addEventListener('click', exportLevelsFile);
      document.getElementById('refreshLevelsBtn').addEventListener('click', function() {
        loadManagedLevels();
        showNotification('–°–ø–∏—Å–æ–∫ —É—Ä–æ–≤–Ω–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω');
      });
      document.getElementById('saveLevelsBtn').addEventListener('click', saveLevelsToFile);
      document.getElementById('clearLevelsBtn').addEventListener('click', clearAllLevels);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–≤–Ω–µ–π –∏–∑ localStorage
    function loadManagedLevels() {
      const saved = localStorage.getItem('mousegame_levels');
      if (saved) {
        managedLevels = JSON.parse(saved);
      }
      updateLevelsList();
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –≤ localStorage
    function saveManagedLevels() {
      localStorage.setItem('mousegame_levels', JSON.stringify(managedLevels));
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞/–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
    function addLevelToManager(code, name, previewData) {
      const levelMatch = code.match(/else\s+if\s+\(level\s*==\s*(\d+)\)/);
      let levelNum = managedLevels.length + 1;
      
      if (levelMatch) {
        levelNum = parseInt(levelMatch[1]);
      }
      
      const existingIndex = managedLevels.findIndex(l => l.number === levelNum);
      if (existingIndex !== -1) {
        if (!confirm(`–£—Ä–æ–≤–µ–Ω—å —Å –Ω–æ–º–µ—Ä–æ–º ${levelNum} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å?`)) {
          return;
        }
        managedLevels[existingIndex] = {
          number: levelNum,
          name: name,
          code: code,
          preview: previewData,
          timestamp: new Date().toISOString()
        };
      } else {
        managedLevels.push({
          number: levelNum,
          name: name,
          code: code,
          preview: previewData,
          timestamp: new Date().toISOString()
        });
      }
      
      managedLevels.sort((a, b) => a.number - b.number);
      
      saveManagedLevels();
      updateLevelsList();
      showNotification(`–£—Ä–æ–≤–µ–Ω—å ${levelNum} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –º–µ–Ω–µ–¥–∂–µ—Ä`);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—Ä–æ–≤–Ω–µ–π
    function updateLevelsList() {
      const container = document.getElementById('levelsList');
      if (!container) return;
      
      if (managedLevels.length === 0) {
        document.getElementById('levelsListContainer').style.display = 'none';
        return;
      }
      
      document.getElementById('levelsListContainer').style.display = 'block';
      container.innerHTML = '';
      
      managedLevels.forEach(level => {
        const levelEl = document.createElement('div');
        levelEl.className = 'level-item';
        levelEl.style.cssText = `
          background: var(--input-bg); 
          border-radius: 10px; 
          padding: 15px; 
          margin-bottom: 10px;
          border-left: 4px solid var(--accent-color);
        `;
        
        levelEl.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong style="color: var(--accent-color);">–£—Ä–æ–≤–µ–Ω—å ${level.number}</strong>
              <div>${level.name}</div>
              <div style="font-size: 12px; color: #888;">${new Date(level.timestamp).toLocaleDateString()}</div>
            </div>
            <div style="display: flex; gap: 5px;">
              <button class="small-tool" onclick="editLevel(${level.number})" style="padding: 5px 10px;">‚úèÔ∏è</button>
              <button class="small-tool" onclick="deleteLevel(${level.number})" style="padding: 5px 10px; background: #ff4444;">üóëÔ∏è</button>
              <button class="small-tool" onclick="moveLevel(${level.number}, -1)" style="padding: 5px 10px;">‚¨ÜÔ∏è</button>
              <button class="small-tool" onclick="moveLevel(${level.number}, 1)" style="padding: 5px 10px;">‚¨áÔ∏è</button>
            </div>
          </div>
        `;
        
        container.appendChild(levelEl);
      });
      
      updateLevelsPreview();
    }

    window.editLevel = function(levelNum) {
  const level = managedLevels.find(l => l.number === levelNum);
  if (level) {
    document.querySelector('[data-tab="editor"]').click();
    
    // –ü–∞—Ä—Å–∏–º –∫–æ–¥ —É—Ä–æ–≤–Ω—è
    const levelData = parseLevelCodeForEditor(level.code);
    
    if (levelData) {
      // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
      networks = [...levelData.networks];
      finishPos = levelData.L_FINISH;
      holeNetworks = levelData.holeNetworks || [];
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
      const levelMatch = level.code.match(/(?:if|else\s+if)\s*\(\s*level\s*==\s*(\d+)\s*\)/);
      if (levelMatch) {
        document.getElementById('levelNum').value = levelMatch[1];
      }
      
      const nameMatch = level.code.match(/\/\/\s*(.+)/);
      if (nameMatch) {
        document.getElementById('levelName').value = nameMatch[1];
      }
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–æ–∑–¥–∞–≤–∞–µ–º—É—é —Å–µ—Ç—å –∏ —Ä–µ–∂–∏–º
      holeNetwork = [];
      currentMode = 'free';
      currentQuickTool = null;
      smallTools.forEach(t => t.classList.remove('active'));
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      updateToolButtons();
      updateVisuals();
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–¥
      const generatedCode = generateLevelCode();
      codeOutput.textContent = generatedCode;
      
      showNotification(`–£—Ä–æ–≤–µ–Ω—å ${levelNum} –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä`);
    } else {
      showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—Ä–æ–≤–Ω—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞.');
    }
  }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–¥–∞ —É—Ä–æ–≤–Ω—è –≤ –¥–∞–Ω–Ω—ã–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
function parseLevelCodeForEditor(code) {
  try {
    const networks = new Array(NUM_LEDS).fill(ELEMENT_TYPES.EMPTY);
    let L_FINISH = 179;
    let holeNetworks = [];
    
    // –í—Ä–µ–º–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ –¥–ª—è —Å–≤—è–∑–µ–π –Ω–æ—Ä
    const holeConnections = new Map();
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º L_FINISH
    const finishMatch = code.match(/L_FINISH\s*=\s*(\d+);/);
    if (finishMatch) {
      L_FINISH = parseInt(finishMatch[1]);
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—Ç –∏ —Ñ–∏–Ω–∏—à
    networks[0] = ELEMENT_TYPES.START;
    networks[L_FINISH] = ELEMENT_TYPES.FINISH;
    
    // –†–∞–∑–¥–µ–ª—è–µ–º –∫–æ–¥ –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
    const lines = code.split('\n');
    
    for (let line of lines) {
      line = line.trim();
      
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
      if (!line || line.startsWith('//')) continue;
      
      // –ò—â–µ–º –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ —Å–µ—Ç–µ–π –Ω–æ—Ä (—Ü–∏—Ñ—Ä–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
      const holeMatch = line.match(/networks\[(\d+)\]\s*=\s*(\d+)\s*;/);
      if (holeMatch) {
        const from = parseInt(holeMatch[1]);
        const to = parseInt(holeMatch[2]);
        
        // –ò—Å–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—Ç, —Ñ–∏–Ω–∏—à –∏ –∑–Ω–∞—á–µ–Ω–∏—è > 180
        if (from !== 0 && to !== 0 && 
            from !== L_FINISH && to !== L_FINISH &&
            to < 180) {
          holeConnections.set(from, to);
          networks[from] = to; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–∫ –Ω–æ—Ä—É
        }
      }
      
      // –ò—â–µ–º –º–µ—à–∫–∏ (–∑–Ω–∞—á–µ–Ω–∏–µ 183)
      const bagMatch = line.match(/networks\[(\d+)\]\s*=\s*183\s*;/);
      if (bagMatch) {
        const pos = parseInt(bagMatch[1]);
        if (pos !== 0 && pos !== L_FINISH) {
          networks[pos] = ELEMENT_TYPES.BAG;
        }
      }
      
      // –ò—â–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç—Ä–æ–ø–∏–Ω–∫–∏ (–∑–Ω–∞—á–µ–Ω–∏–µ 185)
      const pathSingleMatch = line.match(/networks\[(\d+)\]\s*=\s*185\s*;/);
      if (pathSingleMatch) {
        const pos = parseInt(pathSingleMatch[1]);
        if (pos !== 0 && pos !== L_FINISH && networks[pos] === ELEMENT_TYPES.EMPTY) {
          networks[pos] = ELEMENT_TYPES.PATH;
        }
      }
      
      // –ò—â–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã —Ç—Ä–æ–ø–∏–Ω–æ–∫
      const pathRangeMatch = line.match(/for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<=\s*(\d+)\s*;\s*i\+\+\s*\)\s*networks\[i\]\s*=\s*185\s*;/);
      if (pathRangeMatch) {
        const start = parseInt(pathRangeMatch[1]);
        const end = parseInt(pathRangeMatch[2]);
        for (let i = start; i <= end; i++) {
          if (i !== 0 && i !== L_FINISH && networks[i] === ELEMENT_TYPES.EMPTY) {
            networks[i] = ELEMENT_TYPES.PATH;
          }
        }
      }
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ç–∏ –Ω–æ—Ä –∏–∑ —Å–≤—è–∑–µ–π
    if (holeConnections.size > 0) {
      const visited = new Set();
      holeNetworks = [];
      
      for (let [from, to] of holeConnections) {
        if (!visited.has(from)) {
          const network = [];
          let current = from;
          
          // –°–æ–±–∏—Ä–∞–µ–º —Ü–µ–ø–æ—á–∫—É —Å–≤—è–∑–µ–π
          while (holeConnections.has(current) && !visited.has(current)) {
            visited.add(current);
            network.push(current);
            current = holeConnections.get(current);
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω
          if (current && !visited.has(current) && holeConnections.has(current)) {
            visited.add(current);
            network.push(current);
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ç—å, –µ—Å–ª–∏ –≤ –Ω–µ–π –±–æ–ª—å—à–µ 1 –Ω–æ—Ä—ã
          if (network.length > 1) {
            holeNetworks.push(network);
          }
        }
      }
    }
    
    return {
      networks,
      L_FINISH,
      holeNetworks
    };
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–¥–∞ —É—Ä–æ–≤–Ω—è:', error);
    return null;
  }
}

    window.deleteLevel = function(levelNum) {
      if (confirm(`–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å ${levelNum}?`)) {
        managedLevels = managedLevels.filter(l => l.number !== levelNum);
        saveManagedLevels();
        updateLevelsList();
        showNotification(`–£—Ä–æ–≤–µ–Ω—å ${levelNum} —É–¥–∞–ª–µ–Ω`);
      }
    };

    window.moveLevel = function(levelNum, direction) {
      const index = managedLevels.findIndex(l => l.number === levelNum);
      if (index === -1) return;
      
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= managedLevels.length) return;
      
      const temp = managedLevels[index];
      managedLevels[index] = managedLevels[newIndex];
      managedLevels[newIndex] = temp;
      
      saveManagedLevels();
      updateLevelsList();
      showNotification(`–£—Ä–æ–≤–µ–Ω—å ${levelNum} –ø–µ—Ä–µ–º–µ—â–µ–Ω`);
    };

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é —Ñ–∞–π–ª–∞ levels.h
function updateLevelsPreview() {
  const preview = document.getElementById('levelsPreview');
  if (!preview) return;
  
  if (managedLevels.length === 0) {
    preview.textContent = "// –ù–µ—Ç —É—Ä–æ–≤–Ω–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è";
    return;
  }
  
  let code = `#include "constants.h"\n\n`;
  code += `void fillList(byte level) {\n`;
  code += `  for (int i = 0; i < 180; i++) networks[i] = 180;  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–ª–µ—Ç–æ–∫ –∫–∞–∫ –ø—É—Å—Ç—ã—Ö\n\n`;
  
  managedLevels.forEach((level, index) => {
    // –î–ª—è –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è –∏—Å–ø–æ–ª—å–∑—É–µ–º "if", –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö "else if"
    if (index === 0) {
      let levelCode = level.code;
      if (levelCode.startsWith('else if')) {
        levelCode = 'if' + levelCode.substring(7);
      }
      code += `  ${levelCode}\n\n`;
    } else {
      let levelCode = level.code;
      if (!levelCode.startsWith('else if')) {
        if (levelCode.startsWith('if')) {
          levelCode = 'else ' + levelCode;
        }
      }
      code += `  ${levelCode}\n\n`;
    }
  });
  
  code += `}`;
  
  preview.textContent = code;
}

    // –ò–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞ levels.h
    function importLevelsFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.h,.txt';
      
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
          try {
            const content = event.target.result;
            parseLevelsHFile(content);
            showNotification('–§–∞–π–ª levels.h —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω');
          } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + error.message);
          }
        };
        reader.readAsText(file);
      };
      
      input.click();
    }

    // –ü–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–∞ levels.h
function parseLevelsHFile(content) {
  managedLevels = [];
  
  // –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–µ—Å—å —Ñ–∞–π–ª –∫–∞–∫ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–ª–æ–∫–æ–≤
  const lines = content.split('\n');
  let inLevel = false;
  let currentLevel = null;
  let braceCount = 0;
  let levelCode = '';
  let levelStartLine = 0;
  
  // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è
  const cleanLines = [];
  for (let i = 0; i < lines.length; i++) {
    let line = lines[i].trim();
    
    // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
    if (line === '') continue;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å –Ω–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ, –≥–¥–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–¥—ã–¥—É—â–∏–π
    if (line.includes('} else if') || line.includes('}else if')) {
      // –†–∞–∑–¥–µ–ª—è–µ–º –∑–∞–∫—Ä—ã–≤–∞—é—â—É—é —Å–∫–æ–±–∫—É –∏ else if
      const parts = line.split('}');
      if (parts.length > 1) {
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–∫—Ä—ã–≤–∞—é—â—É—é —Å–∫–æ–±–∫—É –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
        cleanLines.push('}');
        // –î–æ–±–∞–≤–ª—è–µ–º else if –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É
        cleanLines.push(parts[1].trim());
      }
    } else {
      cleanLines.push(line);
    }
  }
  
  // –¢–µ–ø–µ—Ä—å –ø–∞—Ä—Å–∏–º –æ—á–∏—â–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
  for (let i = 0; i < cleanLines.length; i++) {
    const line = cleanLines[i];
    
    // –ù–∞—Ö–æ–¥–∏–º –Ω–∞—á–∞–ª–æ —É—Ä–æ–≤–Ω—è (if –∏–ª–∏ else if)
    const levelStartMatch = line.match(/^(if|else\s+if)\s*\(\s*level\s*==\s*(\d+)\s*\)\s*\{/);
    if (levelStartMatch && !inLevel) {
      if (currentLevel) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å
        currentLevel.code = levelCode.trim();
        managedLevels.push(currentLevel);
      }
      
      const levelNum = parseInt(levelStartMatch[2]);
      const nameMatch = line.match(/\/\/\s*(.+)/);
      const levelName = nameMatch ? nameMatch[1].trim() : `–£—Ä–æ–≤–µ–Ω—å ${levelNum}`;
      
      inLevel = true;
      levelStartLine = i;
      braceCount = 1;
      levelCode = line + '\n';
      
      currentLevel = {
        number: levelNum,
        name: levelName,
        code: '',
        preview: null,
        timestamp: new Date().toISOString()
      };
    } else if (inLevel) {
      levelCode += line + '\n';
      
      // –°—á–∏—Ç–∞–µ–º —Ñ–∏–≥—É—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏
      const openBraces = (line.match(/\{/g) || []).length;
      const closeBraces = (line.match(/\}/g) || []).length;
      braceCount += openBraces - closeBraces;
      
      // –ï—Å–ª–∏ –≤—Å–µ —Å–∫–æ–±–∫–∏ –∑–∞–∫—Ä—ã—Ç—ã, –∑–∞–≤–µ—Ä—à–∞–µ–º —É—Ä–æ–≤–µ–Ω—å
      if (braceCount === 0) {
        currentLevel.code = levelCode.trim();
        managedLevels.push(currentLevel);
        
        inLevel = false;
        currentLevel = null;
        levelCode = '';
      }
    }
  }
  
  // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
  if (inLevel && currentLevel) {
    currentLevel.code = levelCode.trim();
    managedLevels.push(currentLevel);
  }
  
  // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —É—Ä–æ–≤–Ω–µ–π, –ø—Ä–æ–±—É–µ–º –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–π –ø–æ–¥—Ö–æ–¥
  if (managedLevels.length === 0) {
    console.log("–ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥...");
    // –ò—â–µ–º –≤—Å–µ –±–ª–æ–∫–∏ —É—Ä–æ–≤–Ω–µ–π –ø—Ä–æ—Å—Ç—ã–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ–º
    const levelRegex = /(?:if|else\s+if)\s*\(\s*level\s*==\s*(\d+)\s*\)\s*\{[^}]*(?:\}[^}]*)*?\}/g;
    let match;
    
    while ((match = levelRegex.exec(content)) !== null) {
      const levelNum = parseInt(match[1]);
      const fullMatch = match[0];
      
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º
      const nameMatch = fullMatch.match(/\/\/\s*(.+)/);
      const levelName = nameMatch ? nameMatch[1].trim() : `–£—Ä–æ–≤–µ–Ω—å ${levelNum}`;
      
      managedLevels.push({
        number: levelNum,
        name: levelName,
        code: fullMatch.trim(),
        preview: null,
        timestamp: new Date().toISOString()
      });
    }
  }
  
  managedLevels.sort((a, b) => a.number - b.number);
  saveManagedLevels();
  updateLevelsList();
  console.log("–ó–∞–≥—Ä—É–∂–µ–Ω–æ —É—Ä–æ–≤–Ω–µ–π:", managedLevels.length);
}

    // –≠–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–∞–π–ª levels.h
function exportLevelsFile() {
  if (managedLevels.length === 0) {
    showNotification('–ù–µ—Ç —É—Ä–æ–≤–Ω–µ–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
    return;
  }
  
  let content = `#include "constants.h"\n\n`;
  content += `void fillList(byte level) {\n`;
  content += `  for (int i = 0; i < 180; i++) networks[i] = 180;  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–ª–µ—Ç–æ–∫ –∫–∞–∫ –ø—É—Å—Ç—ã—Ö\n\n`;
  
  managedLevels.forEach((level, index) => {
    // –î–ª—è –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è –∏—Å–ø–æ–ª—å–∑—É–µ–º "if", –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö "else if"
    if (index === 0) {
      // –ó–∞–º–µ–Ω—è–µ–º "else if" –Ω–∞ "if" –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è
      let code = level.code;
      if (code.startsWith('else if')) {
        code = 'if' + code.substring(7);
      }
      content += `  ${code}\n\n`;
    } else {
      // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —ç—Ç–æ "else if"
      let code = level.code;
      if (!code.startsWith('else if')) {
        if (code.startsWith('if')) {
          code = 'else ' + code;
        }
      }
      content += `  ${code}\n\n`;
    }
  });
  
  content += `}`;
  
  const blob = new Blob([content], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'levels.h';
  a.click();
  URL.revokeObjectURL(url);
  
  showNotification('–§–∞–π–ª levels.h —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
}

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –≤ —Ñ–∞–π–ª
    function saveLevelsToFile() {
      exportLevelsFile();
    }

    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π
    function clearAllLevels() {
      if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —É—Ä–æ–≤–Ω–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        managedLevels = [];
        saveManagedLevels();
        updateLevelsList();
        showNotification('–í—Å–µ —É—Ä–æ–≤–Ω–∏ –æ—á–∏—â–µ–Ω—ã');
      }
    }
  </script>
</body>
</html>
